<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>U.C.P. - Portal de Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, onSnapshot, query, getDocs, deleteDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig = {};
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        } catch (e) { console.error("Error parsing config:", e); }

        const app = Object.keys(firebaseConfig).length ? initializeApp(firebaseConfig) : null;
        const auth = app ? getAuth(app) : null;
        const db = app ? getFirestore(app) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ucp-spc-v1';

        window.fbDb = db;
        window.fbAppId = appId;
        window.fbDoc = doc;
        window.fbSetDoc = setDoc;
        window.fbAddDoc = addDoc;
        window.fbCollection = collection;
        window.fbDeleteDoc = deleteDoc;
        window.fbUpdateDoc = updateDoc;
        window.fbGetDocs = getDocs;

        window.SYSTEM_USERS = [{
            username: '136219951',
            password: 'Marquitos123',
            fullName: 'MARCOS MAG√çN GUTI√âRREZ RUARTE',
            role: 'ADMINISTRADOR',
            multiRole: true
        }];

        const initAuth = async () => {
            const hideLoader = () => {
                const loader = document.getElementById('global-loader');
                if (loader) {
                    loader.classList.add('opacity-0');
                    setTimeout(() => loader.remove(), 300);
                }
            };

            if (!auth) {
                hideLoader();
                return;
            }

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                const ensureAdmin = async () => {
                    if (!db) return;
                    try {
                        const adminRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', '136219951');
                        await setDoc(adminRef, window.SYSTEM_USERS[0], { merge: true });
                    } catch (e) { }
                };
                ensureAdmin();

            } catch (error) {
                console.error("Auth Error:", error);
            } finally {
                hideLoader();
            }
        };

        if (db && auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    const errorLog = (err) => console.warn("Firestore Error:", err);

                    // Escucha de Ingresos
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'ingresos'), (snapshot) => {
                        let data = [];
                        snapshot.forEach(doc => data.push({id: doc.id, ...doc.data()}));
                        data.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                        window.ingresosRecientes = data.slice(0, 500); 
                        if (window.updateIngresosTable) window.updateIngresosTable();
                        if (window.updateReportTable) window.updateReportTable();
                    }, errorLog);

                    // Escucha de Usuarios del Sistema
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snapshot) => {
                        const data = [];
                        snapshot.forEach(doc => data.push(doc.data()));
                        if (data.length > 0) window.SYSTEM_USERS = data;
                        if (window.refreshUsersList) window.refreshUsersList();
                    }, errorLog);

                    // Escucha de Base de Personal
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'personal'), (snapshot) => {
                        const data = [];
                        snapshot.forEach(doc => data.push(doc.data()));
                        window.PERSONAL_DB = data;
                        if(document.getElementById('total-personal')) document.getElementById('total-personal').innerText = data.length;
                        if(document.getElementById('dash-total-personal')) document.getElementById('dash-total-personal').innerText = data.length;
                        // Forzar actualizaci√≥n de reportes ya que dependen de los nombres en la base de personal
                        if (window.updateReportTable) window.updateReportTable();
                        if (window.updateIngresosTable) window.updateIngresosTable();
                    }, errorLog);

                    // Escucha de Pases Body Scan
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'pases_body'), (snapshot) => {
                        const data = [];
                        snapshot.forEach(doc => data.push({id: doc.id, ...doc.data()}));
                        window.pasesBodyData = data;
                        if(document.getElementById('total-body')) document.getElementById('total-body').innerText = data.length;
                    }, errorLog);

                    // Escucha de Logs de Actividad
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'activity_logs'), (snapshot) => {
                        let data = [];
                        snapshot.forEach(doc => data.push({id: doc.id, ...doc.data()}));
                        data.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                        window.activityLogs = data.slice(0, 500);
                        if (window.updateActivityLogsTable) window.updateActivityLogsTable();
                    }, errorLog);
                    
                    setTimeout(syncOfflineData, 2000);
                }
            });
        }

        window.onload = () => {
            const savedTheme = localStorage.getItem('theme');
            const btn = document.getElementById('theme-btn');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                if (btn) btn.innerText = '‚òÄÔ∏è';
            } else {
                document.documentElement.classList.remove('dark');
                if (btn) btn.innerText = 'üåô';
            }
            initAuth();
            initUI();
            
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    if (typeof requestWakeLock === 'function') requestWakeLock();
                }
            });

            window.addEventListener('popstate', (event) => {
                if (event.state && event.state.view) {
                    renderView(event.state.view, event.state.title, false);
                }
            });

            window.addEventListener('online', syncOfflineData);
            setInterval(syncOfflineData, 60000);
        };

        window.fbUpdatePersonal = async (list) => {
            if(!db) return;
            const chunks = [];
            for (let i = 0; i < list.length; i += 400) chunks.push(list.slice(i, i + 400));
            for (const chunk of chunks) {
                const batch = writeBatch(db);
                chunk.forEach(p => batch.set(doc(db, 'artifacts', appId, 'public', 'data', 'personal', p.id), p, { merge: true }));
                await batch.commit();
                await sleep(100);
            }
            await logActivity("IMPORTACI√ìN BASE PERSONAL (" + list.length + " REGISTROS)");
        };

        window.fbUpdateBody = async (list) => {
            if(!db) return;
            const chunks = [];
            for (let i = 0; i < list.length; i += 400) chunks.push(list.slice(i, i + 400));
            for (const chunk of chunks) {
                const batch = writeBatch(db);
                chunk.forEach(p => batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'pases_body')), p));
                await batch.commit();
                await sleep(100);
            }
            await logActivity("IMPORTACI√ìN BASE BODY SCAN (" + list.length + " REGISTROS)");
        };

        const sleep = (ms) => new Promise(res => setTimeout(res, ms));

        window.logActivity = async (detail) => {
            if (!currentUser || !db) return;
            const now = new Date();
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'activity_logs'), {
                    timestamp: Date.now(),
                    fecha: now.toISOString().split('T')[0],
                    hora: now.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' }),
                    userId: currentUser.username,
                    userName: currentUser.fullName,
                    detail: detail.toUpperCase()
                });
            } catch (e) { console.error("Log error:", e); }
        };

        async function syncOfflineData() {
            if (!navigator.onLine || !currentUser || !db) return;
            const pending = JSON.parse(localStorage.getItem('PENDING_INGRESOS') || '[]');
            if (pending.length === 0) return;

            let successful = [];
            for (const data of pending) {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ingresos'), data);
                    successful.push(data.timestamp);
                } catch (e) { }
            }
            const remaining = pending.filter(p => !successful.includes(p.timestamp));
            localStorage.setItem('PENDING_INGRESOS', JSON.stringify(remaining));
            if (successful.length > 0) showMessage(`Sincronizados ${successful.length} registros pendientes.`, "success");
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        input[type="text"], textarea { text-transform: uppercase; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #reader { width: 100% !important; border: none !important; min-height: 250px; background: #000; overflow: hidden; }
        #reader video { object-fit: cover !important; }
        @media print {
            aside, header, .no-print, .pagination-controls, .search-container { display: none !important; }
            main { margin: 0 !important; padding: 0 !important; width: 100% !important; }
            .print-table { display: table !important; width: 100% !important; font-size: 6.5pt !important; line-height: 1 !important; border-collapse: collapse; }
            th, td { padding: 1.5px 3px !important; border: 0.5px solid #94a3b8; }
            .print-header { display: block !important; margin-bottom: 5px; font-size: 8pt; font-weight: 900; }
        }
    </style>
</head>
<body class="h-full bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 overflow-hidden text-left">

    <div id="global-loader" class="fixed inset-0 z-[1000] bg-slate-900 flex flex-col items-center justify-center text-center transition-opacity duration-300">
        <div class="mb-6 relative">
            <div class="w-12 h-12 border-4 border-blue-600/20 border-t-blue-600 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center font-black text-blue-600 text-[9px]">UCP</div>
        </div>
        <h2 class="text-white font-black uppercase text-sm mb-1 text-center">Iniciando Portal</h2>
        <p class="text-slate-500 font-bold uppercase text-[7px] tracking-widest animate-pulse text-center">Carga Segura</p>
    </div>

    <div id="toast-wrapper" class="fixed top-4 right-4 z-[2000] flex flex-col gap-2 pointer-events-none text-left"></div>

    <div id="sidebar-overlay" onclick="toggleSidebar(false)" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[45] hidden transition-opacity opacity-0"></div>

    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-slate-900 px-4">
        <div id="login-box" class="max-w-md w-full bg-white dark:bg-slate-800 p-8 rounded-[2rem] shadow-2xl animate-fade-in text-center"></div>
    </div>

    <div id="role-screen" class="hidden fixed inset-0 z-[200] bg-slate-900 flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white dark:bg-slate-800 p-8 rounded-[2.5rem] shadow-2xl text-center">
            <h2 class="text-xl font-black uppercase tracking-tighter mb-1 dark:text-white text-center">Seleccione Perfil</h2>
            <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-6 text-center">Acceso con m√∫ltiples permisos</p>
            <div id="role-options" class="grid grid-cols-1 gap-3"></div>
        </div>
    </div>

    <div id="app-container" class="hidden h-full flex overflow-hidden">
        <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-[50] w-64 bg-slate-800 dark:bg-slate-900 text-white transform -translate-x-full lg:translate-x-0 sidebar-transition shadow-2xl flex flex-col shrink-0 text-left">
            <div class="p-5 flex flex-col h-full text-left">
                <div class="flex items-center gap-3 mb-6">
                    <div class="bg-blue-600 p-2 rounded-xl font-black text-xs text-white">UCP</div>
                    <div class="text-left">
                        <span class="font-black text-base tracking-tighter uppercase block leading-none">Portal U.C.P.</span>
                        <span class="text-[7px] text-blue-400 font-bold uppercase tracking-widest">Seguridad Penitenciaria</span>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto no-scrollbar py-2 text-left"><nav id="sidebar-nav" class="space-y-1 text-left"></nav></div>
                <div class="mt-auto pt-4 border-t border-slate-700/50">
                    <div class="flex items-center gap-3 mb-4 p-3 bg-slate-700/30 rounded-xl relative">
                        <div id="user-initial" class="w-9 h-9 rounded-lg bg-blue-600 flex items-center justify-center font-black text-base shadow-inner text-white">?</div>
                        <div class="overflow-hidden text-left flex-1">
                            <p id="user-display-name" class="text-[10px] font-black truncate uppercase text-blue-100">Cargando...</p>
                            <p id="user-display-role" class="text-[8px] text-slate-400 uppercase font-bold tracking-tighter">Rol</p>
                        </div>
                        <button id="btn-switch-role" onclick="openRoleSwitcher()" class="hidden absolute -top-2 -right-2 w-7 h-7 bg-blue-500 rounded-full border-2 border-slate-800 flex items-center justify-center text-[10px] shadow-lg">üîÑ</button>
                    </div>
                    <button onclick="logout()" class="w-full py-2.5 text-[9px] font-black text-red-400 hover:bg-red-500/10 rounded-lg transition-all uppercase tracking-widest border border-red-500/20 text-center">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-slate-50 dark:bg-slate-950 relative overflow-hidden text-left">
            <header class="h-14 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-6 z-30 shadow-sm shrink-0 no-print text-left">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar(true)" class="lg:hidden p-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-lg">‚ò∞</button>
                    <h2 id="view-title" class="text-base md:text-lg font-black text-slate-800 dark:text-white uppercase tracking-tighter">Inicio</h2>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleFullscreen()" title="Pantalla Completa" class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-md transition-all">‚õ∂</button>
                    <button onclick="toggleTheme()" id="theme-btn" title="Alternar Modo" class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-md transition-all">üåô</button>
                </div>
            </header>
            <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-6 no-scrollbar text-left"></div>
        </main>
    </div>

    <!-- MODALES -->
    <div id="modal-data" class="hidden fixed inset-0 z-[120] bg-slate-900/90 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-5xl h-[85vh] rounded-[2rem] overflow-hidden shadow-2xl flex flex-col">
            <div class="p-5 bg-blue-600 text-white flex justify-between items-center shrink-0">
                <h3 id="modal-data-title" class="font-black uppercase text-sm tracking-widest italic text-left">Base de Datos</h3>
                <button onclick="closeDataModal()" class="p-2 bg-white/20 rounded-full hover:bg-white/40 transition-all text-center">‚úï</button>
            </div>
            <div class="p-4 border-b dark:border-slate-800 bg-slate-50 dark:bg-slate-800/30 flex flex-wrap gap-3 items-center">
                <input type="text" id="modal-search" oninput="updateModalTable()" placeholder="BUSCAR EN ESTA BASE..." class="flex-1 min-w-[200px] px-4 py-2 bg-white dark:bg-slate-900 border-2 rounded-xl text-[10px] font-black outline-none focus:border-blue-500 uppercase text-left">
                <div class="flex gap-2">
                    <button onclick="prevModalPage()" class="p-2 bg-white dark:bg-slate-900 border-2 rounded-xl text-xs font-black text-center">‚Üê</button>
                    <span id="modal-page-num" class="px-4 py-2 font-black text-[10px] uppercase pt-3 text-center">P√°g 1</span>
                    <button onclick="nextModalPage()" class="p-2 bg-white dark:bg-slate-900 border-2 rounded-xl text-xs font-black text-center">‚Üí</button>
                </div>
            </div>
            <div class="flex-1 overflow-auto p-2 no-scrollbar">
                <table class="w-full text-left text-[11px] text-left">
                    <thead id="modal-data-head" class="bg-slate-50 dark:bg-slate-800 sticky top-0 font-black uppercase text-[9px] text-left"></thead>
                    <tbody id="modal-data-body" class="divide-y dark:divide-slate-800 font-bold uppercase text-slate-600 dark:text-slate-400 text-left"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-scanner" class="hidden fixed inset-0 z-[120] bg-slate-900/95 backdrop-blur-md flex flex-col items-center justify-center p-4 text-center">
        <div class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-3xl overflow-hidden shadow-2xl relative flex flex-col">
            <div class="p-4 bg-blue-600 text-white flex justify-between items-center z-20">
                <span id="scanner-title" class="font-black uppercase text-xs tracking-widest italic text-left">Escaneo Activo</span>
                <button onclick="stopScanner()" class="p-2 bg-white/20 rounded-full hover:bg-white/40 transition-all text-center">‚úï</button>
            </div>
            <div id="reader"></div>
        </div>
    </div>

    <div id="modal-calendar" class="hidden fixed inset-0 z-[150] bg-slate-900/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl flex flex-col text-center">
            <div class="p-5 bg-blue-600 text-white font-black uppercase text-sm tracking-widest italic flex justify-between">
                <span class="text-left">Resumen por Fecha</span>
                <button onclick="document.getElementById('modal-calendar').classList.add('hidden')" class="text-white text-lg">‚úï</button>
            </div>
            <div class="p-4 overflow-y-auto max-h-[60vh] no-scrollbar">
                <div id="calendar-list" class="space-y-2 text-left"></div>
            </div>
            <button onclick="document.getElementById('modal-calendar').classList.add('hidden')" class="w-full p-4 bg-slate-100 dark:bg-slate-800 font-black uppercase text-[10px] text-slate-500 hover:text-blue-600 text-center">Cerrar</button>
        </div>
    </div>

    <script>
        const ROLES = { ADMIN: 'ADMINISTRADOR', DIP: 'DEPARTAMENTO INSPECCI√ìN PENITENCIARIA', UCP: 'UNIDAD DE CONTROL PENITENCIARIO' };
        const PROFILES = ['PERSONAL', 'MOVIL', 'MONOTRIBUTISTA', 'DOCENTE', 'ABOGADO', 'PASTORAL', 'VISITA', 'OTROS'];

        window.PERSONAL_DB = []; window.ingresosRecientes = []; window.pasesBodyData = []; window.activityLogs = [];
        let currentUser = null; let activeRole = null; let html5QrCode = null;
        let currentPage = 1; const pageSize = 40; let editingId = null;
        let modalFullData = []; let modalHeaders = []; let modalPage = 1; const modalPageSize = 30;

        function playBeep(freq = 440, duration = 150) {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.04, audioCtx.currentTime);
                oscillator.connect(gainNode); gainNode.connect(audioCtx.destination);
                oscillator.start(); setTimeout(() => oscillator.stop(), duration);
            } catch(e) {}
        }

        function showMessage(text, type = 'info') {
            const wrapper = document.getElementById('toast-wrapper');
            const toast = document.createElement('div');
            const colors = { 'info': 'bg-blue-600', 'success': 'bg-emerald-600', 'error': 'bg-red-600' };
            toast.className = `${colors[type]} text-white px-5 py-3 rounded-2xl shadow-xl font-black text-[10px] uppercase tracking-widest animate-fade-in pointer-events-auto flex items-center gap-3 text-left`;
            toast.innerHTML = `<span>${text}</span>`;
            wrapper.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-10px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        let wakeLock = null;
        async function requestWakeLock() {
            if (!('wakeLock' in navigator)) return;
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) { }
        }

        function initUI() {
            document.getElementById('login-box').innerHTML = `
                <div class="bg-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-xl text-white font-black text-xl">SP</div>
                <h1 class="text-xl font-black text-slate-800 dark:text-white uppercase tracking-tighter mb-1 text-center">Control U.C.P.</h1>
                <p class="text-slate-500 text-[9px] font-bold uppercase tracking-widest italic mb-6 text-center">Acceso Restringido</p>
                <form id="login-form" class="space-y-4 text-left" onsubmit="event.preventDefault(); handleLogin();">
                    <div class="flex gap-2">
                        <input type="text" id="username" class="flex-1 px-4 py-3 rounded-xl border-2 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 text-center text-base font-black outline-none focus:border-blue-500 dark:text-white uppercase" placeholder="MATR√çCULA / DNI">
                        <button type="button" onclick="startScanner('LOGIN')" class="p-3 bg-slate-100 dark:bg-slate-700 text-slate-500 rounded-xl hover:bg-blue-600 hover:text-white transition-all text-center">üìü</button>
                    </div>
                    <input type="password" id="password" class="w-full px-4 py-3 rounded-xl border-2 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 text-center text-base font-black outline-none focus:border-blue-500 dark:text-white" placeholder="CONTRASE√ëA">
                    <button type="submit" class="w-full bg-slate-800 dark:bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg uppercase tracking-widest text-[10px] text-center">Ingresar</button>
                </form>`;
        }

        async function handleLogin() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value;
            const user = window.SYSTEM_USERS.find(x => x.username === u && x.password === p);
            if (user) {
                playBeep(880, 100); currentUser = user;
                if (typeof requestWakeLock === 'function') requestWakeLock();
                if (user.multiRole || user.role === ROLES.ADMIN) openRoleSwitcher();
                else startSession(user.role);
            } else showMessage("Credenciales incorrectas", "error");
        }

        function openRoleSwitcher() {
            const container = document.getElementById('role-options');
            const availableRoles = [ROLES.UCP, ROLES.DIP, ROLES.ADMIN];
            container.innerHTML = availableRoles.map(role => `
                <button onclick="startSession('${role}')" class="w-full py-3 bg-slate-100 dark:bg-slate-700 hover:bg-blue-600 hover:text-white transition-all rounded-xl font-black uppercase text-[10px] text-center">${role}</button>
            `).join('');
            document.getElementById('role-screen').classList.remove('hidden');
        }

        function startSession(role) {
            activeRole = role;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('role-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('user-display-name').innerText = currentUser.fullName;
            document.getElementById('user-display-role').innerText = activeRole;
            document.getElementById('user-initial').innerText = currentUser.fullName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            if (currentUser.multiRole || currentUser.role === ROLES.ADMIN) document.getElementById('btn-switch-role').classList.remove('hidden');
            buildMenu(); renderView('dashboard', 'Inicio'); logActivity("INICIO DE SESI√ìN - ROL: " + role);
        }

        function buildMenu() {
            const nav = document.getElementById('sidebar-nav');
            const items = [{ id: 'ingresos', label: 'REGISTRO DE INGRESOS', icon: 'üìù' }, { id: 'reportes', label: 'M√ìDULO REPORTES', icon: 'üìä' }];
            if (activeRole !== ROLES.UCP) items.push({ id: 'importar_personal', label: 'IMPORTAR PERSONAL', icon: 'üì•' }, { id: 'pases_body', label: 'PASES BODY', icon: 'üîç' });
            items.push({ id: 'users_admin', label: 'GESTI√ìN DE USUARIOS', icon: 'üë•' });
            if (activeRole === ROLES.ADMIN) items.push({ id: 'activity_log', label: 'REGISTRO ACTIVIDAD', icon: 'üìú' });
            nav.innerHTML = items.map(item => `
                <button onclick="renderView('${item.id}', '${item.label}')" class="w-full flex items-center gap-2 px-3 py-2 text-[10px] font-bold rounded-lg hover:bg-slate-700 transition-all text-left uppercase">
                    <span class="text-base text-left">${item.icon}</span> <span class="font-black text-left">${item.label}</span>
                </button>`).join('');
        }

        function renderView(viewId, title, saveState = true) {
            if (window.innerWidth < 1024) toggleSidebar(false);
            document.getElementById('view-title').innerText = title;
            const content = document.getElementById('content-area');
            currentPage = 1; editingId = null;
            if (saveState) window.history.pushState({ view: viewId, title: title }, title);
            if (viewId === 'dashboard') {
                content.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 animate-fade-in text-left">
                    <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border dark:border-slate-800 shadow-sm text-left">
                        <p class="text-[8px] font-black uppercase text-slate-400">Hoy</p>
                        <p class="text-2xl font-black text-blue-600">${window.ingresosRecientes.length}</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border dark:border-slate-800 shadow-sm text-left">
                        <p class="text-[8px] font-black uppercase text-slate-400">Agentes Base</p>
                        <p class="text-2xl font-black text-emerald-600" id="dash-total-personal">${window.PERSONAL_DB.length}</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border dark:border-slate-800 shadow-sm text-left">
                        <p class="text-[8px] font-black uppercase text-slate-400">Terminal</p>
                        <p class="text-base font-black uppercase truncate">${getOperatorID()}</p>
                    </div>
                </div>
                <div class="flex flex-col items-center justify-center p-8 bg-white dark:bg-slate-900 rounded-[3rem] border dark:border-slate-800 text-center shadow-sm text-left">
                    <img src="https://raw.githubusercontent.com/gutierrezruarte/BibliotecaSPC/main/Escudo-1-279x300-removebg-preview.png" class="w-20 mb-6 mx-auto text-center">
                    <h2 class="text-xl font-black uppercase italic dark:text-white leading-none text-center">Unidad de Control Penitenciario</h2>
                    <p class="text-[8px] text-slate-400 font-bold uppercase tracking-[0.2em] mt-3 text-center">Portal de Auditor√≠a y Acceso</p>
                </div>`;
            } else if (viewId === 'ingresos') renderIngresosView(content);
            else if (viewId === 'reportes') renderReportesView(content);
            else if (viewId === 'users_admin') renderUsersAdminView(content);
            else if (viewId === 'importar_personal') renderImportPersonalView(content);
            else if (viewId === 'pases_body') renderPasesBodyView(content);
            else if (viewId === 'activity_log') renderActivityLogView(content);
        }

        function renderIngresosView(container) {
            const now = new Date();
            container.innerHTML = `
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-5 animate-fade-in h-full text-left">
                <div class="xl:col-span-5 text-left">
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-[2rem] border dark:border-slate-800 shadow-xl text-left">
                        <form id="ingreso-form" class="space-y-4 text-left" onsubmit="event.preventDefault(); handleSaveIngreso();">
                            <h3 id="form-label" class="text-[10px] font-black uppercase text-blue-600 mb-2 italic text-left">Registro Acceso</h3>
                            <div class="grid grid-cols-2 gap-3 text-left">
                                <input type="date" id="ing-fecha" value="${now.toISOString().split('T')[0]}" class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-800 border-2 rounded-lg font-bold text-[11px] outline-none text-left">
                                <input type="time" id="ing-hora" value="${now.toTimeString().split(' ')[0].substring(0, 5)}" class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-800 border-2 rounded-lg font-bold text-[11px] outline-none text-left">
                            </div>
                            <select id="ing-perfil" onchange="updateDynamicFields(this.value)" class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-800 border-2 rounded-lg font-black uppercase text-[10px] outline-none text-left">
                                <option value="" disabled selected>Perfil...</option>${PROFILES.map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                            <div id="dyn-fields" class="space-y-3 text-left"></div>
                            <div class="grid grid-cols-1 gap-2 text-left">
                                <div class="flex gap-1 text-left" id="transport-options">
                                    <button type="button" onclick="setMode('PEAT√ìN')" id="btn-p" class="flex-1 py-2 border-2 rounded-lg transition-all text-xl text-center">üö∂</button>
                                    <button type="button" onclick="setMode('VEH√çCULO')" id="btn-v" class="flex-1 py-2 border-2 rounded-lg transition-all text-xl text-center">üöó</button>
                                </div>
                            </div>
                            <div id="vehicle-fields" class="hidden text-left"><input type="text" id="ing-dominio" class="w-full px-4 py-3 bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 rounded-lg text-lg font-black text-center text-blue-800 dark:text-blue-300" placeholder="PATENTE"></div>
                            <input type="hidden" id="ing-modo" value=""><textarea id="ing-obs" rows="2" class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-800 border-2 rounded-lg font-bold text-[10px] text-left" placeholder="DESTINO / OBSERVACIONES"></textarea>
                            <button type="submit" id="btn-submit" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black uppercase tracking-widest text-[9px] shadow-lg text-center">Finalizar Registro</button>
                        </form>
                    </div>
                </div>
                <div class="xl:col-span-7 bg-white dark:bg-slate-900 rounded-[2rem] border dark:border-slate-800 overflow-hidden shadow-sm flex flex-col text-left">
                    <div class="p-4 border-b dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50 font-black text-slate-400 uppercase text-[8px] tracking-widest flex justify-between text-left"><span>Recientes</span><span>OP: ${getOperatorID()}</span></div>
                    <div class="flex-1 overflow-auto no-scrollbar text-left"><table class="w-full text-left text-[11px] text-left"><tbody id="ingresos-table" class="divide-y dark:divide-slate-800 text-left"></tbody></table></div>
                </div>
            </div>`;
            window.updateIngresosTable();
        }

        function renderReportesView(container) {
            container.innerHTML = `
            <div class="bg-white dark:bg-slate-900 p-6 rounded-[2.5rem] shadow-sm border dark:border-slate-800 h-full flex flex-col text-left">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 shrink-0 no-print text-left">
                    <h3 class="text-xl font-black text-slate-800 dark:text-white uppercase tracking-tighter italic text-left">Auditor√≠a Acceso</h3>
                    <div class="flex gap-2 w-full md:w-auto text-center">
                        <button onclick="viewCalendarTotals('ingresos')" class="p-2.5 bg-slate-100 dark:bg-slate-800 rounded-xl hover:bg-blue-600 transition-all text-center">üìÖ</button>
                        <button onclick="exportToExcel()" class="flex-1 bg-emerald-600 text-white px-6 py-2.5 rounded-2xl font-black text-[10px] uppercase text-center">Excel</button>
                        <button onclick="window.print()" class="flex-1 bg-blue-600 text-white px-6 py-2.5 rounded-2xl font-black text-[10px] uppercase text-center">PDF COMPRIMIDO</button>
                    </div>
                </div>
                <div class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-3 no-print text-left">
                    <div class="md:col-span-2 text-left"><input type="text" id="report-search" oninput="updateReportTable()" placeholder="B√öSQUEDA R√ÅPIDA..." class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-800 border-2 rounded-xl text-[10px] font-black outline-none focus:border-blue-500 uppercase text-left"></div>
                    <div class="flex gap-2 text-left">
                        <input type="date" id="report-from" onchange="updateReportTable()" class="flex-1 px-3 py-2 bg-slate-50 dark:bg-slate-800 border-2 rounded-xl text-[9px] font-black outline-none text-left">
                        <input type="date" id="report-to" onchange="updateReportTable()" class="flex-1 px-3 py-2 bg-slate-50 dark:bg-slate-800 border-2 rounded-xl text-[9px] font-black outline-none text-left">
                    </div>
                </div>
                <div class="flex-1 overflow-hidden flex flex-col text-left">
                    <div class="overflow-auto flex-1 no-scrollbar border dark:border-slate-800 rounded-2xl text-left">
                        <table class="w-full text-left print-table text-left">
                            <thead class="bg-slate-50 dark:bg-slate-800 text-slate-500 font-black uppercase text-[7px] sticky top-0 text-left">
                                <tr>
                                    <th class="px-2 py-3 border-b dark:border-slate-700 text-left">FECHA/HORA</th>
                                    <th class="px-2 py-3 border-b dark:border-slate-700 text-left">IDENTIDAD (DNI)</th>
                                    <th class="px-2 py-3 border-b dark:border-slate-700 text-left">NOMBRE / CARGO</th>
                                    <th class="px-2 py-3 border-b dark:border-slate-700 text-left">MODO / DOMINIO</th>
                                    <th class="px-2 py-3 border-b dark:border-slate-700 text-left">OP</th>
                                    <th class="px-2 py-3 border-b dark:border-slate-700 no-print text-left">X</th>
                                </tr>
                            </thead>
                            <tbody id="report-table-body" class="divide-y dark:divide-slate-800 font-bold uppercase text-slate-600 dark:text-slate-400 text-left"></tbody>
                        </table>
                    </div>
                </div>
            </div>`;
            window.updateReportTable();
        }

        function renderUsersAdminView(container) {
            container.innerHTML = `
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 animate-fade-in text-left">
                <div class="xl:col-span-4 text-left">
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-[2rem] border dark:border-slate-800 shadow-xl text-left">
                        <h3 class="text-xs font-black uppercase mb-4 italic text-left">Alta Operador</h3>
                        <form id="user-form" class="space-y-3 text-left" onsubmit="event.preventDefault(); handleSaveUser();">
                            <input type="text" id="u-user" class="w-full px-4 py-2.5 bg-slate-50 dark:bg-slate-800 border-2 rounded-xl font-black text-xs text-left" placeholder="DNI / MATR√çCULA">
                            <input type="text" id="u-name" class="w-full px-4 py-2.5 bg-slate-50 dark:bg-slate-800 border-2 rounded-xl font-black text-xs text-left" placeholder="NOMBRE COMPLETO">
                            <input type="password" id="u-pass" class="w-full px-4 py-2.5 bg-slate-50 dark:bg-slate-800 border-2 rounded-xl font-black text-xs text-left" placeholder="CONTRASE√ëA">
                            <select id="u-role" class="w-full px-4 py-2.5 bg-slate-50 dark:bg-slate-800 border-2 rounded-xl font-black text-xs uppercase text-left">
                                <option value="${ROLES.UCP}">${ROLES.UCP}</option>
                                <option value="${ROLES.DIP}">${ROLES.DIP}</option>
                                <option value="${ROLES.ADMIN}">${ROLES.ADMIN}</option>
                            </select>
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-black uppercase text-[10px] shadow-lg text-center">Registrar</button>
                        </form>
                    </div>
                </div>
                <div class="xl:col-span-8 bg-white dark:bg-slate-900 rounded-[2rem] border dark:border-slate-800 overflow-hidden text-left">
                    <table class="w-full text-left text-[11px] text-left text-left"><tbody id="users-list-body" class="divide-y dark:divide-slate-800 text-left"></tbody></table>
                </div>
            </div>`;
            window.refreshUsersList();
        }

        function renderImportPersonalView(container) {
            container.innerHTML = `
            <div class="max-w-4xl mx-auto space-y-6 animate-fade-in text-left">
                <div class="bg-white dark:bg-slate-900 p-10 rounded-[2.5rem] border dark:border-slate-800 shadow-2xl flex flex-col md:flex-row items-center justify-between gap-8 text-left">
                    <div class="text-left flex-1 text-left">
                        <h2 class="text-2xl font-black uppercase mb-1 tracking-tighter italic text-left">Importar Personal</h2>
                        <div class="flex items-center gap-6 mt-4 text-left">
                            <div class="bg-blue-50 dark:bg-blue-900/20 px-6 py-3 rounded-2xl border dark:border-blue-900/50 text-left">
                                <span class="text-[10px] font-black text-blue-600 block mb-1 uppercase text-left">Agentes</span>
                                <span id="total-personal" class="text-2xl font-black dark:text-white text-left">0</span>
                            </div>
                            <button onclick="viewPersonalData()" class="p-4 bg-slate-100 dark:bg-slate-800 rounded-2xl hover:bg-blue-600 transition-all text-center">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <div class="w-full max-w-sm flex flex-col gap-4 text-left">
                        <div class="border-2 border-dashed dark:border-slate-700 rounded-3xl p-8 bg-slate-50 dark:bg-slate-950 text-center cursor-pointer hover:bg-white transition-all text-center" onclick="document.getElementById('personal-file').click()">
                            <input type="file" id="personal-file" class="hidden" onchange="updateFileName('personal-file-label', this)">
                            <p id="personal-file-label" class="text-[11px] text-slate-400 font-black italic uppercase text-center">Seleccionar Excel Personal</p>
                        </div>
                        <button onclick="processPersonalFile()" class="bg-blue-600 text-white py-5 rounded-2xl font-black uppercase tracking-widest text-[11px] shadow-lg text-center">Actualizar Base</button>
                    </div>
                </div>
            </div>`;
            if (window.PERSONAL_DB) document.getElementById('total-personal').innerText = window.PERSONAL_DB.length;
        }

        function renderPasesBodyView(container) {
            container.innerHTML = `
            <div class="max-w-4xl mx-auto space-y-6 animate-fade-in text-left">
                <div class="bg-white dark:bg-slate-900 p-10 rounded-[2.5rem] border dark:border-slate-800 shadow-2xl flex flex-col md:flex-row items-center justify-between gap-8 text-left">
                    <div class="text-left flex-1 text-left">
                        <h2 class="text-2xl font-black uppercase mb-1 tracking-tighter italic text-left">Base Body Scan</h2>
                        <div class="flex items-center gap-6 mt-4 text-left">
                            <div class="bg-amber-50 dark:bg-amber-900/20 px-6 py-3 rounded-2xl border dark:border-amber-900/50 text-left">
                                <span class="text-[10px] font-black text-amber-600 block mb-1 uppercase text-left">Registros</span>
                                <span id="total-body" class="text-2xl font-black dark:text-white text-left">0</span>
                            </div>
                            <button onclick="viewCalendarTotals('body')" class="p-4 bg-slate-100 dark:bg-slate-800 rounded-2xl hover:bg-amber-500 transition-all text-center">üìÖ</button>
                            <button onclick="viewBodyData()" class="p-4 bg-slate-100 dark:bg-slate-800 rounded-2xl hover:bg-amber-500 transition-all text-center">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <div class="w-full max-w-sm flex flex-col gap-4 text-left">
                        <div class="border-2 border-dashed dark:border-slate-700 rounded-3xl p-8 bg-slate-50 dark:bg-slate-950 text-center cursor-pointer hover:bg-white transition-all text-center" onclick="document.getElementById('body-file').click()">
                            <input type="file" id="body-file" class="hidden" onchange="updateFileName('body-file-label', this)">
                            <p id="body-file-label" class="text-[11px] text-slate-400 font-black italic uppercase text-center">Sincronizar Body Scan (.xlsx)</p>
                        </div>
                        <button onclick="processBodyFile()" class="bg-amber-600 text-white py-5 rounded-2xl font-black uppercase tracking-widest text-[11px] shadow-lg text-center">Importar Nuevos</button>
                    </div>
                </div>
            </div>`;
            if (window.pasesBodyData) document.getElementById('total-body').innerText = window.pasesBodyData.length;
        }

        function renderActivityLogView(container) {
            container.innerHTML = `
            <div class="bg-white dark:bg-slate-900 p-6 rounded-[2.5rem] shadow-sm border dark:border-slate-800 h-full flex flex-col text-left">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 shrink-0 no-print text-left">
                    <h3 class="text-xl font-black text-slate-800 dark:text-white uppercase tracking-tighter italic text-left">Registro de Actividad</h3>
                    <div class="flex gap-2 w-full md:w-auto text-center">
                        <button onclick="exportActivityToExcel()" class="flex-1 bg-emerald-600 text-white px-6 py-2.5 rounded-2xl font-black text-[10px] uppercase text-center">Exportar logs</button>
                    </div>
                </div>
                <div class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-3 no-print text-left">
                    <div class="md:col-span-2 text-left"><input type="text" id="log-search" oninput="updateActivityLogsTable()" placeholder="BUSCAR OPERADOR O ACCI√ìN..." class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-800 border-2 rounded-xl text-[10px] font-black outline-none focus:border-blue-500 uppercase text-left"></div>
                    <div class="flex gap-2 text-left">
                        <input type="date" id="log-from" onchange="updateActivityLogsTable()" class="flex-1 px-3 py-2 bg-slate-50 dark:bg-slate-800 border-2 rounded-xl text-[9px] font-black outline-none text-left">
                        <input type="date" id="log-to" onchange="updateActivityLogsTable()" class="flex-1 px-3 py-2 bg-slate-50 dark:bg-slate-800 border-2 rounded-xl text-[9px] font-black outline-none text-left">
                    </div>
                </div>
                <div class="flex-1 overflow-hidden flex flex-col text-left">
                    <div class="overflow-auto flex-1 no-scrollbar border dark:border-slate-800 rounded-2xl text-left">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 dark:bg-slate-800 text-slate-500 font-black uppercase text-[7px] sticky top-0 text-left">
                                <tr>
                                    <th class="px-3 py-3 border-b dark:border-slate-700 text-left">FECHA/HORA</th>
                                    <th class="px-3 py-3 border-b dark:border-slate-700 text-left">USUARIO</th>
                                    <th class="px-3 py-3 border-b dark:border-slate-700 text-left">DETALLE</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body" class="divide-y dark:divide-slate-800 font-bold uppercase text-slate-600 dark:text-slate-400 text-left"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-between items-center no-print text-left">
                        <p id="logs-count" class="text-[9px] font-black text-slate-400 uppercase tracking-widest text-left"></p>
                        <div class="flex gap-2 text-left">
                            <button onclick="prevLogPage()" class="px-3 py-2 bg-slate-100 dark:bg-slate-800 rounded-xl font-black text-xs text-center">‚Üê</button>
                            <span class="text-[10px] font-black uppercase pt-2 text-left" id="page-num-logs">P√°g. 1</span>
                            <button onclick="nextLogPage()" class="px-3 py-2 bg-slate-100 dark:bg-slate-800 rounded-xl font-black text-xs text-center">‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>`;
            window.logCurrentPage = 1; updateActivityLogsTable();
        }

        window.updateActivityLogsTable = function() {
            const body = document.getElementById('logs-table-body'); if (!body) return;
            const search = document.getElementById('log-search').value.toUpperCase();
            const from = document.getElementById('log-from').value;
            const to = document.getElementById('log-to').value;
            let filtered = (window.activityLogs || []).filter(l => {
                const matchesSearch = !search || JSON.stringify(l).toUpperCase().includes(search);
                const matchesFrom = !from || l.fecha >= from;
                const matchesTo = !to || l.fecha <= to;
                return matchesSearch && matchesFrom && matchesTo;
            });
            const pSize = 30; const total = Math.ceil(filtered.length / pSize);
            const slice = filtered.slice((window.logCurrentPage - 1) * pSize, window.logCurrentPage * pSize);
            body.innerHTML = slice.map(l => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 text-left">
                    <td class="px-3 py-2 text-left leading-tight"><b>${l.fecha}</b><br><span class="font-mono text-blue-500 text-left">${l.hora}</span></td>
                    <td class="px-3 py-2 text-left leading-tight font-black text-slate-800 dark:text-white">${l.userName}<br><span class="text-[7px] text-slate-400">ID: ${l.userId}</span></td>
                    <td class="px-3 py-2 text-left text-[9px] text-slate-500 dark:text-slate-300 font-bold">${l.detail}</td>
                </tr>`).join('');
            document.getElementById('logs-count').innerText = `TOTAL: ${filtered.length}`;
            document.getElementById('page-num-logs').innerText = `P√°g. ${window.logCurrentPage} de ${total || 1}`;
        };

        window.prevLogPage = () => { if(window.logCurrentPage > 1) { window.logCurrentPage--; updateActivityLogsTable(); } };
        window.nextLogPage = () => { if(window.logCurrentPage * 30 < (window.activityLogs || []).length) { window.logCurrentPage++; updateActivityLogsTable(); } };

        window.updateIngresosTable = function() {
            const b = document.getElementById('ingresos-table'); if (!b) return;
            const records = (window.ingresosRecientes || []).slice(0, 15);
            b.innerHTML = records.map(i => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 text-left">
                    <td class="px-5 py-4 font-mono text-blue-600 font-black text-sm text-left">${i.hora}</td>
                    <td class="px-5 py-4 text-left">
                        <div class="font-black text-[10px] text-slate-800 dark:text-white uppercase leading-none mb-1 text-left">${i.nomSujeto || i.sujeto}</div>
                        <div class="text-[8px] text-slate-400 font-bold text-left">${i.perfil} | ${i.modo}</div>
                    </td>
                    <td class="px-5 py-4 text-right">
                        ${(activeRole === ROLES.UCP || activeRole === ROLES.ADMIN) ? `<button onclick="editIngreso('${i.id}')" class="text-blue-500 mr-2">‚úèÔ∏è</button>` : ''}
                        ${(activeRole === ROLES.DIP || activeRole === ROLES.ADMIN) ? `<button onclick="deleteIngreso('${i.id}')" class="text-red-500">üóëÔ∏è</button>` : ''}
                    </td>
                </tr>`).join('');
        };

        window.updateReportTable = function() {
            const body = document.getElementById('report-table-body'); if (!body) return;
            const search = document.getElementById('report-search').value.toUpperCase();
            const from = document.getElementById('report-from').value;
            const to = document.getElementById('report-to').value;
            let filtered = (window.ingresosRecientes || []).filter(i => {
                const matchesSearch = !search || JSON.stringify(i).toUpperCase().includes(search);
                const matchesFrom = !from || i.fecha >= from;
                const matchesTo = !to || i.fecha <= to;
                return matchesSearch && matchesFrom && matchesTo;
            });
            const records = filtered.slice((currentPage - 1) * pageSize, currentPage * pageSize);
            body.innerHTML = records.map(i => {
                const p = (window.PERSONAL_DB || []).find(x => String(x.id).trim() === String(i.sujeto).trim());
                const nomYcargo = p ? `<div class="font-black text-slate-700 dark:text-slate-300 leading-none text-left">${p.apellido} ${p.nombre}</div><div class="text-[6.5px] text-blue-400 text-left">${p.cargo}</div>` : `<div class="font-black text-slate-700 dark:text-slate-300 leading-none text-left">${i.nomSujeto || 'NO IDENTIFICADO'}</div><div class="text-[6.5px] text-slate-400 text-left">${i.perfil}</div>`;
                return `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 text-left">
                    <td class="px-2 py-1 leading-tight text-left"><b>${i.fecha}</b><br><span class="font-mono text-blue-500 text-left">${i.hora}</span></td>
                    <td class="px-2 py-1 font-black text-slate-800 dark:text-white leading-none text-left">${i.sujeto}<br><span class="text-[6.5px] text-slate-400 text-left">${i.perfil}</span></td>
                    <td class="px-2 py-1 text-left">${nomYcargo}</td>
                    <td class="px-2 py-1 text-[8px] text-left">${i.modo} ${i.dominio || i.nMovil || ""}</td>
                    <td class="px-2 py-1 font-black text-blue-600 text-left">${i.operador}</td>
                    <td class="px-2 py-1 no-print text-left">${activeRole === ROLES.DIP || activeRole === ROLES.ADMIN ? `<button onclick="deleteIngreso('${i.id}')">üóëÔ∏è</button>` : ''}</td>
                </tr>`;
            }).join('');
        };

        window.refreshUsersList = function() {
            const body = document.getElementById('users-list-body'); if (!body) return;
            body.innerHTML = (window.SYSTEM_USERS || []).map(u => `<tr class="hover:bg-slate-50 dark:hover:bg-slate-800 text-left"><td class="px-5 py-4 text-left"><div class="font-black uppercase text-left">${u.fullName}</div><div class="text-[8px] text-slate-400 font-bold uppercase text-left">${u.role} | ID: ${u.username}</div></td><td class="px-5 py-4 text-right">${u.username !== currentUser.username ? `<button onclick="deleteSystemUser('${u.username}')" class="p-2 bg-red-100 text-red-600 rounded-lg text-xs">üóëÔ∏è</button>` : ''}</td></tr>`).join('');
        };

        function toggleTheme() {
            const doc = document.documentElement; const isDark = doc.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            const btn = document.getElementById('theme-btn'); if (btn) btn.innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => {});
            else document.exitFullscreen();
        }

        function editIngreso(id) {
            editingId = id; const i = window.ingresosRecientes.find(x => x.id === id); if (!i) return;
            renderView('ingresos', 'REGISTRO DE INGRESOS (EDICI√ìN)');
            setTimeout(() => {
                document.getElementById('ing-fecha').value = i.fecha; document.getElementById('ing-hora').value = i.hora;
                document.getElementById('ing-perfil').value = i.perfil; updateDynamicFields(i.perfil);
                if (i.perfil === 'PERSONAL' || i.perfil === 'MOVIL') { document.getElementById('ing-mat').value = i.sujeto; searchPersonalInDB(i.sujeto); }
                else { document.getElementById('ing-dni').value = i.sujeto; document.getElementById('ing-nom').value = i.nomSujeto; }
                setMode(i.modo); if (i.modo === 'VEH√çCULO') document.getElementById('ing-dominio').value = i.dominio;
                document.getElementById('ing-obs').value = i.obs; document.getElementById('btn-submit').innerText = "Actualizar Registro";
            }, 100);
        }

        async function deleteIngreso(id) {
            if(confirm("¬øEliminar registro?")) {
                await window.fbDeleteDoc(window.fbDoc(window.fbDb, 'artifacts', window.fbAppId, 'public', 'data', 'ingresos', id));
                await logActivity("ELIMINACI√ìN REGISTRO ID: " + id); showMessage("Registro Eliminado", "success");
            }
        }

        function updateDynamicFields(perfil) {
            const d = document.getElementById('dyn-fields'); if (!d) return; d.innerHTML = '';
            if (perfil === 'MOVIL' || perfil === 'PERSONAL') {
                d.innerHTML = `
                    <div class="space-y-3 animate-fade-in text-left">
                        <div class="flex gap-2 text-left">
                            <input type="text" id="ing-mat" oninput="this.value = this.value.toUpperCase(); searchPersonalInDB(this.value)" class="flex-1 px-4 py-2.5 bg-slate-50 dark:bg-slate-800 border-2 rounded-lg text-xs font-black uppercase outline-none text-left" placeholder="AFILIADO / MATR√çCULA">
                            <button type="button" onclick="startScanner('BARCODE')" class="p-2.5 bg-slate-100 dark:bg-slate-800 border-2 rounded-lg hover:bg-blue-600 hover:text-white transition-all text-center">üìü</button>
                        </div>
                        <div id="personal-preview" class="hidden p-4 bg-emerald-50 dark:bg-emerald-900/20 border-2 border-emerald-200 rounded-2xl text-left">
                            <div id="prev-name" class="font-black uppercase text-emerald-800 dark:text-emerald-400 text-xs mb-2 text-left"></div>
                            <div id="body-analytics" class="space-y-2 border-t dark:border-emerald-900/50 pt-2 text-left"></div>
                        </div>
                    </div>`;
            } else {
                d.innerHTML = `
                    <div class="space-y-3 animate-fade-in text-left">
                        <div class="flex gap-2 text-left">
                            <input type="text" id="ing-dni" class="flex-1 px-4 py-2.5 bg-slate-50 dark:bg-slate-800 border-2 rounded-lg text-xs font-black outline-none text-left" placeholder="DNI">
                            <button type="button" onclick="startScanner('QR')" class="p-2.5 bg-slate-100 dark:bg-slate-800 border-2 rounded-lg hover:bg-blue-600 hover:text-white transition-all text-center">üì∏</button>
                        </div>
                        <input type="text" id="ing-nom" class="w-full px-4 py-2.5 bg-slate-50 dark:bg-slate-800 border-2 rounded-lg text-xs font-black uppercase outline-none text-left" placeholder="APELLIDO Y NOMBRE">
                    </div>`;
            }
        }

        function handleScanSuccess(text, type) {
            playBeep(440, 150); stopScanner();
            if (type === 'QR') {
                const parts = text.split('@').map(s => s.trim());
                if (parts.length >= 8) { document.getElementById('ing-dni').value = parts[4]; document.getElementById('ing-nom').value = `${parts[1]} ${parts[2]}`; }
                else if (parts.length >= 4) { document.getElementById('ing-dni').value = parts[0]; document.getElementById('ing-nom').value = `${parts[1]} ${parts[2]}`; }
                else document.getElementById('ing-dni').value = text;
            } else if (type === 'BARCODE') { document.getElementById('ing-mat').value = text; searchPersonalInDB(text); }
            else if (type === 'LOGIN') document.getElementById('username').value = text;
        }

        function searchPersonalInDB(val) {
            const id = val.trim(); if (!id) { const preview = document.getElementById('personal-preview'); if (preview) preview.classList.add('hidden'); return; }
            const p = (window.PERSONAL_DB || []).find(x => String(x.id).trim() === id);
            const preview = document.getElementById('personal-preview');
            const now = new Date(); const sixtyDays = 60 * 24 * 60 * 60 * 1000;
            const pases = (window.pasesBodyData || []).filter(b => {
                if (String(b.matricula).trim() !== id) return false;
                let d; const dateStr = String(b.fechaHora).split(' ')[0];
                const pt = dateStr.includes('/') ? dateStr.split('/') : dateStr.split('-');
                if (pt.length === 3) { let year = pt[2]; if (year.length === 2) year = "20" + year; d = new Date(`${year}-${pt[1]}-${pt[0]}`); }
                else d = new Date(b.fechaHora);
                return !isNaN(d.getTime()) && (now - d) < sixtyDays;
            }).sort((a,b) => {
                const dateA = new Date(a.fechaHora.includes('/') ? a.fechaHora.split('/').reverse().join('-') : a.fechaHora);
                const dateB = new Date(b.fechaHora.includes('/') ? b.fechaHora.split('/').reverse().join('-') : b.fechaHora);
                return dateB - dateA;
            });
            if (!p && pases.length === 0) { if(preview) preview.classList.add('hidden'); return; }
            if (p) { document.getElementById('prev-name').innerText = `${p.apellido}, ${p.nombre} [${p.cargo}]`; }
            else { document.getElementById('prev-name').innerText = "SUJETO NO EN BASE PERSONAL"; }
            document.getElementById('body-analytics').innerHTML = `
                <div class="flex justify-between items-center mb-1 text-left"><span class="text-[9px] font-black text-slate-500 text-left text-left">Pases Body (60d)</span><span class="bg-blue-600 text-white px-2 py-0.5 rounded text-[10px] text-center text-center">${pases.length}</span></div>
                <div class="max-h-20 overflow-auto text-[8px] font-bold text-slate-400 no-scrollbar text-left text-left">
                    ${pases.map(pase => `<div class="text-left text-left">‚Ä¢ ${pase.fechaHora} [${pase.sector}]</div>`).join('') || '<div class="text-red-500 italic text-left text-left">SIN REGISTROS RECIENTES</div>'}
                </div>`;
            preview.classList.remove('hidden');
        }

        async function handleSaveIngreso() {
            const p = document.getElementById('ing-perfil').value; const m = document.getElementById('ing-modo').value;
            if (!p || !m) return showMessage("Faltan datos clave.", "error");
            const data = {
                fecha: document.getElementById('ing-fecha').value, hora: document.getElementById('ing-hora').value,
                perfil: p, modo: m, sujeto: (document.getElementById('ing-dni')?.value || document.getElementById('ing-mat')?.value || "S/D").toUpperCase(),
                nomSujeto: (document.getElementById('ing-nom')?.value || "").toUpperCase(), obs: document.getElementById('ing-obs').value.toUpperCase(),
                dominio: (document.getElementById('ing-dominio')?.value || "").toUpperCase(), operador: getOperatorID(), timestamp: Date.now()
            };
            if (editingId) {
                try {
                    await window.fbUpdateDoc(window.fbDoc(window.fbDb, 'artifacts', window.fbAppId, 'public', 'data', 'ingresos', editingId), data);
                    await logActivity("EDICI√ìN REGISTRO ID: " + editingId); playBeep(660, 150);
                    showMessage("Registro Actualizado", "success"); renderView('ingresos', 'REGISTRO DE INGRESOS');
                } catch (e) { showMessage("Error de conexi√≥n.", "error"); }
                return;
            }
            try {
                if(!window.fbDb) throw new Error("Offline");
                await window.fbAddDoc(window.fbCollection(window.fbDb, 'artifacts', window.fbAppId, 'public', 'data', 'ingresos'), data);
                await logActivity("NUEVO INGRESO: " + data.sujeto + " - " + data.perfil);
                playBeep(660, 150); showMessage("Registro Guardado", "success");
            } catch (e) {
                const pending = JSON.parse(localStorage.getItem('PENDING_INGRESOS') || '[]'); pending.push(data);
                localStorage.setItem('PENDING_INGRESOS', JSON.stringify(pending)); showMessage("Sin se√±al. Guardado localmente.", "info"); playBeep(330, 300);
            }
            renderView('ingresos', 'REGISTRO DE INGRESOS');
        }

        async function handleSaveUser() {
            const u = document.getElementById('u-user').value.trim(), n = document.getElementById('u-name').value.trim(), p = document.getElementById('u-pass').value, r = document.getElementById('u-role').value;
            if(!u || !n || !p) return showMessage("Complete los campos", "error");
            await window.fbSetDoc(window.fbDoc(window.fbDb, 'artifacts', window.fbAppId, 'public', 'data', 'users', u), { username: u, fullName: n.toUpperCase(), password: p, role: r, multiRole: r === ROLES.ADMIN });
            await logActivity("GESTI√ìN DE USUARIO: " + u); showMessage("Usuario Actualizado", "success"); document.getElementById('user-form').reset();
        }

        async function deleteSystemUser(id) {
            if(confirm("¬øEliminar operador?")) {
                await window.fbDeleteDoc(window.fbDoc(window.fbDb, 'artifacts', window.fbAppId, 'public', 'data', 'users', id));
                await logActivity("ELIMINACI√ìN USUARIO: " + id); showMessage("Usuario Eliminado", "success");
            }
        }

        async function processPersonalFile() {
            const input = document.getElementById('personal-file'); if (!input || !input.files.length) return showMessage("Seleccione Excel", "error");
            const reader = new FileReader(); reader.onload = async (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const js = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                const list = js.map(row => {
                    let id = "", nom = "", ape = "", jer = "AGENTE";
                    Object.keys(row).forEach(key => {
                        const ck = key.toUpperCase().trim();
                        if(ck === "MATRICULA" || ck === "AFILIADO" || ck === "ID") id = String(row[key]).split('.')[0].trim();
                        if(ck === "NOMBRE" || ck === "NOMBRES") nom = String(row[key]).trim().toUpperCase();
                        if(ck === "APELLIDO" || ck === "APELLIDOS") ape = String(row[key]).trim().toUpperCase();
                        if(ck === "JERARQUIA" || ck === "CARGO") jer = String(row[key]).trim().toUpperCase();
                    });
                    return { id, nombre: nom, apellido: ape, cargo: jer };
                }).filter(p => p.id);
                await window.fbUpdatePersonal(list); showMessage("Sincronizaci√≥n completa.", "success");
            };
            reader.readAsArrayBuffer(input.files[0]);
        }

        async function processBodyFile() {
            const input = document.getElementById('body-file'); if (!input || !input.files.length) return showMessage("Seleccione Excel", "error");
            const existingKeys = new Set((window.pasesBodyData || []).map(p => `${p.matricula}_${p.fechaHora}`));
            const reader = new FileReader(); reader.onload = async (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const js = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                const list = js.map(row => {
                    let mat = "", nom = "", fec = "", sec = "U.C.P.";
                    Object.keys(row).forEach(key => {
                        const ck = key.toUpperCase().trim();
                        if(ck === "MATRICULA" || ck === "AFILIADO" || ck === "ID") mat = String(row[key]).split('.')[0].trim();
                        if(ck === "NOMBRE" || ck === "SUJETO") nom = String(row[key]).trim().toUpperCase();
                        if(ck.includes("FECHA") || ck.includes("HORA")) fec = String(row[key]).trim();
                        if(ck.includes("SECTOR")) sec = String(row[key]).trim().toUpperCase();
                    });
                    return { matricula: mat, nombre: nom, fechaHora: fec, sector: sec };
                }).filter(p => p.matricula && !existingKeys.has(`${p.matricula}_${p.fechaHora}`));
                if (list.length === 0) return showMessage("Sin registros nuevos.", "info");
                await window.fbUpdateBody(list); showMessage(`Importados ${list.length}.`, "success");
            };
            reader.readAsArrayBuffer(input.files[0]);
        }

        function viewCalendarTotals(type) {
            const counts = {}; const data = type === 'ingresos' ? window.ingresosRecientes : window.pasesBodyData;
            data.forEach(i => { const d = type === 'ingresos' ? i.fecha : i.fechaHora.split(' ')[0]; counts[d] = (counts[d] || 0) + 1; });
            const sorted = Object.keys(counts).sort((a,b) => b.localeCompare(a));
            document.getElementById('calendar-list').innerHTML = sorted.map(d => `
                <div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800 rounded-xl border dark:border-slate-700 text-left text-left">
                    <span class="font-black text-[9px] uppercase text-slate-500 text-left text-left">${d}</span>
                    <span class="bg-blue-600 text-white px-3 py-1 rounded-full font-black text-xs text-center text-center text-center">${counts[d]}</span>
                </div>`).join('');
            document.getElementById('modal-calendar').classList.remove('hidden');
        }

        function getOperatorID() { return currentUser ? `${currentUser.fullName.split(' ').map(n=>n[0]).join('')}-${currentUser.username.slice(-3)}` : "S/D"; }
        function toggleSidebar(f) { const s = document.getElementById('sidebar'), o = document.getElementById('sidebar-overlay'); if(f === false || (!f && !s.classList.contains('-translate-x-full'))) { s.classList.add('-translate-x-full'); o.classList.add('hidden'); } else { s.classList.remove('-translate-x-full'); o.classList.remove('hidden'); } }
        function logout() { window.location.reload(); }
        function setMode(m) {
            document.getElementById('ing-modo').value = m;
            document.getElementById('btn-p').className = `flex-1 py-2 border-2 rounded-lg text-xl text-center ${m==='PEAT√ìN'?'bg-blue-600 text-white border-blue-600 shadow-lg':'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700'}`;
            document.getElementById('btn-v').className = `flex-1 py-2 border-2 rounded-lg text-xl text-center ${m==='VEH√çCULO'?'bg-blue-600 text-white border-blue-600 shadow-lg':'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700'}`;
            if (m==='VEH√çCULO') document.getElementById('vehicle-fields').classList.remove('hidden'); else document.getElementById('vehicle-fields').classList.add('hidden');
        }
        function closeDataModal() { document.getElementById('modal-data').classList.add('hidden'); }
        function startScanner(type) {
            document.getElementById('scanner-title').innerText = type; document.getElementById('modal-scanner').classList.remove('hidden');
            if(html5QrCode) html5QrCode.clear(); html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 20, aspectRatio: 1.0 }, (t) => handleScanSuccess(t, type)).catch(() => stopScanner());
        }
        function stopScanner() { if(html5QrCode) html5QrCode.stop().finally(() => { html5QrCode.clear(); document.getElementById('modal-scanner').classList.add('hidden'); }); }
        function updateFileName(id, input) { if(input.files.length) document.getElementById(id).innerText = input.files[0].name.toUpperCase(); }
        function prevModalPage() { if(modalPage > 1) { modalPage--; updateModalTable(); } }
        function nextModalPage() { if(modalPage * modalPageSize < (modalFullData || []).length) { modalPage++; updateModalTable(); } }
        function viewPersonalData() { openDataModal("BASE PERSONAL", ["ID", "APELLIDO", "NOMBRE", "CARGO"], (window.PERSONAL_DB || []).map(p => [p.id, p.apellido, p.nombre, p.cargo])); }
        function viewBodyData() { openDataModal("HISTORIAL BODY SCAN", ["ID", "NOMBRE", "FECHA/HORA", "SECTOR"], (window.pasesBodyData || []).map(p => [p.matricula, p.nombre, p.fechaHora, p.sector])); }
        function openDataModal(title, headers, rows) {
            modalFullData = rows; modalHeaders = headers; modalPage = 1;
            document.getElementById('modal-data-title').innerText = title;
            document.getElementById('modal-data-head').innerHTML = `<tr>${headers.map(h => `<th class="px-4 py-4 border-b dark:border-slate-700 font-black text-left text-left text-left">${h}</th>`).join('')}</tr>`;
            updateModalTable(); document.getElementById('modal-data').classList.remove('hidden');
        }
        function updateModalTable() {
            const q = document.getElementById('modal-search').value.toUpperCase();
            const filt = (modalFullData || []).filter(r => r.some(c => String(c).toUpperCase().includes(q)));
            const slice = filt.slice((modalPage - 1) * modalPageSize, modalPage * modalPageSize);
            document.getElementById('modal-data-body').innerHTML = slice.map(row => `<tr>${row.map(cell => `<td class="px-4 py-3 border-b dark:border-slate-800 text-left text-left">${cell}</td>`).join('')}</tr>`).join('');
            document.getElementById('modal-page-num').innerText = `P√°g ${modalPage} de ${Math.ceil(filt.length / modalPageSize) || 1}`;
        }
        function exportToExcel() {
            const data = (window.ingresosRecientes || []).map(i => ({ Fecha: i.fecha, Hora: i.hora, Perfil: i.perfil, Sujeto: i.sujeto, Nombre: i.nomSujeto, Modo: i.modo, Operador: i.operador }));
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "UCP"); XLSX.writeFile(wb, `Auditoria_UCP.xlsx`);
        }
        function exportActivityToExcel() {
            const data = (window.activityLogs || []).map(l => ({ Fecha: l.fecha, Hora: l.hora, Usuario: l.userName, ID: l.userId, Accion: l.detail }));
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Actividad"); XLSX.writeFile(wb, `Logs_Actividad_UCP.xlsx`);
        }
    </script>
</body>
</html>
