<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>U.C.P. - Portal de Control Integrado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkBg: '#020617',
                        darkCard: '#0f172a'
                    }
                }
            }
        }

        const applyTheme = () => {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        };
        applyTheme();
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, onSnapshot, writeBatch, query, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const configPersonal = { apiKey: "AIzaSyDly2M3_eGocS28O-EcO6FreL3be0wfZEE", authDomain: "ucp-personal.firebaseapp.com", projectId: "ucp-personal", appId: "1:715461905934:web:3e2dd5fe658ca5d61cb65f" };
        const configBody = { apiKey: "AIzaSyAUiha-utdBuHMe-pcQxeperw0pa3VlnHA", authDomain: "ucp-body.firebaseapp.com", projectId: "ucp-body", appId: "1:422629681048:web:007824b4fee476ac46aded" };
        const configRegistros = { apiKey: "AIzaSyBmvj542a67pQpa-2Ls5WJrun9OqlFH0Js", authDomain: "ucp-registros.firebaseapp.com", projectId: "ucp-registros", appId: "1:450418291282:web:b810cfcbf02df79708a58b" };

        const appP = initializeApp(configPersonal, "appPersonal");
        const appB = initializeApp(configBody, "appBody");
        const appR = initializeApp(configRegistros, "appRegistros");

        const authP = getAuth(appP); const authB = getAuth(appB); const authR = getAuth(appR);
        const dbP = getFirestore(appP); const dbB = getFirestore(appB); const dbR = getFirestore(appR);

        window.fbDbPersonal = dbP; window.fbDbBody = dbB; window.fbDbRegistros = dbR;
        window.fbAddDoc = addDoc; window.fbCollection = collection; window.fbDoc = doc; 
        window.fbWriteBatch = writeBatch; window.fbDeleteDoc = deleteDoc; window.fbUpdateDoc = updateDoc;
        window.fbSetDoc = setDoc;

        window.PERSONAL_DB = JSON.parse(localStorage.getItem('ucp_cache_personal') || '[]');
        window.pasesBodyData = JSON.parse(localStorage.getItem('ucp_cache_body') || '[]');
        window.ingresosRecientes = JSON.parse(localStorage.getItem('ucp_cache_ingresos') || '[]');
        window.SYSTEM_USERS = [];
        window.importStats = JSON.parse(localStorage.getItem('ucp_import_stats') || '{"personal": {"date": "-", "count": 0}, "body": {"date": "-", "count": 0}}');

        const initAuth = async () => {
            const loader = document.getElementById('global-loader');
            try {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                const authTask = async (authInst) => {
                    if (token) await signInWithCustomToken(authInst, token);
                    else await signInAnonymously(authInst);
                };
                await Promise.allSettled([authTask(authP), authTask(authB), authTask(authR)]);
                setupDataListeners();
            } catch (e) { console.error(e); }
            finally { if(loader) loader.remove(); }
        };

        function setupDataListeners() {
            onSnapshot(collection(dbP, 'artifacts', 'ucp-personal', 'public', 'data', 'personal'), (snap) => {
                const data = []; snap.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                window.PERSONAL_DB = data; localStorage.setItem('ucp_cache_personal', JSON.stringify(data));
                updateUIStats();
                if(window.currentViewId === 'importar_personal') renderView('importar_personal', 'PERSONAL');
                if(window.updateFullReport) window.updateFullReport();
            });

            onSnapshot(collection(dbB, 'artifacts', 'ucp-body', 'public', 'data', 'pases_body'), (snap) => {
                const data = []; snap.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                window.pasesBodyData = data; localStorage.setItem('ucp_cache_body', JSON.stringify(data));
                updateUIStats();
                if(window.currentViewId === 'importar_body') renderView('importar_body', 'BODY SCAN');
                const matInput = document.getElementById('ing-mat');
                if(matInput && matInput.value) window.searchPersonalInDB(matInput.value);
            });

            onSnapshot(collection(dbR, 'artifacts', 'ucp-registros', 'public', 'data', 'ingresos'), (snap) => {
                let data = []; snap.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                data.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                window.ingresosRecientes = data; localStorage.setItem('ucp_cache_ingresos', JSON.stringify(data.slice(0, 100)));
                if (window.updateIngresosTable) window.updateIngresosTable();
                if (window.updateFullReport) window.updateFullReport();
                updateUIStats();
            });

            onSnapshot(collection(dbR, 'artifacts', 'ucp-registros', 'public', 'data', 'users'), (snap) => {
                const data = []; snap.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                window.SYSTEM_USERS = data;
                if (window.refreshUsersList) window.refreshUsersList();
            });
        }

        function updateUIStats() {
            const set = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
            set('dash-total-personal', window.PERSONAL_DB.length);
            set('dash-total-body', window.pasesBodyData.length);
            set('dash-total-ingresos', window.ingresosRecientes.length);
        }

        window.onload = () => { 
            initAuth(); 
            initUI(); 
            updateThemeToggleIcon();
            window.onpopstate = (event) => {
                if (event.state && event.state.viewId) {
                    renderView(event.state.viewId, event.state.label, true);
                } else if (currentUser) {
                    renderView('dashboard', 'Inicio', true);
                }
            };
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .dark body { background-color: #020617 !important; color: #f1f5f9 !important; }
        .dark main { background-color: #020617 !important; }
        .dark #app-container { background-color: #020617 !important; }
        input[type="text"], textarea, select { text-transform: uppercase; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        @media print {
            aside, header, .no-print { display: none !important; }
            main, #content-area { margin: 0 !important; padding: 0 !important; width: 100% !important; height: auto !important; overflow: visible !important; }
            #app-container { display: block !important; height: auto !important; }
            .print-table { width: 100% !important; border-collapse: collapse !important; font-size: 6.5pt !important; color: black !important; }
            .print-table th, .print-table td { border: 1px solid #000 !important; padding: 1px 3px !important; line-height: 1 !important; vertical-align: middle !important; }
            .print-table th { background: #e2e8f0 !important; font-weight: 900 !important; text-transform: uppercase; border: 1.5px solid #000 !important; }
            .print-header-info { display: block !important; margin-bottom: 5px; border-bottom: 2px solid black; padding-bottom: 3px; }
            @page { size: portrait; margin: 0.5cm; }
        }
    </style>
</head>
<body class="h-full bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 overflow-hidden text-left">

    <div id="global-loader" class="fixed inset-0 z-[1000] bg-slate-900 flex flex-col items-center justify-center text-center">
        <div class="w-12 h-12 border-4 border-blue-600/20 border-t-blue-600 rounded-full animate-spin mb-4 mx-auto"></div>
        <h2 class="text-white font-black uppercase text-[10px] tracking-[0.3em]">Cruce de Datos SPC Activo</h2>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 z-[4000] bg-slate-950/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2rem] p-8 border-4 border-red-600 shadow-2xl text-center">
            <div class="text-4xl mb-4 text-center">‚ö†Ô∏è</div>
            <h3 class="text-lg font-black uppercase dark:text-white mb-2 leading-tight">¬øConfirmar Acci√≥n?</h3>
            <p id="confirm-text" class="text-xs font-bold text-slate-500 mb-6 uppercase tracking-tighter">Esta acci√≥n es irreversible.</p>
            <div id="confirm-stage-1" class="space-y-3 text-center">
                <button onclick="stageConfirm(2)" class="w-full bg-red-600 text-white font-black py-4 rounded-xl uppercase text-[10px] tracking-widest hover:bg-red-700">Eliminar Registro</button>
                <button onclick="closeConfirmModal()" class="w-full bg-slate-200 dark:bg-slate-800 dark:text-white font-black py-4 rounded-xl uppercase text-[10px] tracking-widest">Cancelar</button>
            </div>
            <div id="confirm-stage-2" class="hidden space-y-3 text-center">
                <button id="final-confirm-btn" class="w-full bg-red-700 text-white font-black py-4 rounded-xl uppercase text-[10px] tracking-widest border-2 border-white shadow-lg">CONFIRMACI√ìN FINAL</button>
            </div>
        </div>
    </div>

    <div id="upload-overlay" class="hidden fixed inset-0 z-[3000] bg-slate-950/80 backdrop-blur-sm flex flex-col items-center justify-center p-6 text-center">
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm p-8 rounded-[2.5rem] shadow-2xl border border-slate-200 dark:border-slate-700 text-center">
            <div class="w-10 h-10 border-4 border-blue-600/20 border-t-blue-600 rounded-full animate-spin mx-auto mb-4 text-center"></div>
            <h3 class="text-xs font-black uppercase text-slate-800 dark:text-white mb-1 tracking-widest text-center">Sincronizando Nube</h3>
            <div class="w-full bg-slate-100 dark:bg-slate-900 h-2 rounded-full overflow-hidden mt-4 text-center">
                <div id="upload-bar" class="bg-blue-600 h-full w-0 transition-all duration-300 text-center"></div>
            </div>
            <p id="upload-count" class="text-[8px] font-black text-blue-600 mt-2 uppercase text-center">0 / 0 registros</p>
        </div>
    </div>

    <div id="toast-wrapper" class="fixed top-4 right-4 z-[2000] flex flex-col gap-2 pointer-events-none"></div>

    <div id="role-screen" class="hidden fixed inset-0 z-[200] bg-slate-900/90 flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white dark:bg-slate-800 p-8 rounded-[2.5rem] shadow-2xl text-center">
            <h2 class="text-xl font-black uppercase tracking-tighter mb-1 dark:text-white italic text-center">Acceso Jer√°rquico</h2>
            <div id="role-options" class="grid grid-cols-1 gap-3 mt-6 text-center"></div>
        </div>
    </div>

    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-slate-50 dark:bg-slate-950 px-4 transition-colors">
        <div id="login-box" class="max-w-md w-full bg-white dark:bg-slate-800 p-8 rounded-[2.5rem] shadow-2xl text-center border border-slate-100 dark:border-slate-700 mx-auto text-center"></div>
    </div>

    <div id="app-container" class="hidden h-full flex overflow-hidden dark:bg-slate-950">
        <aside id="sidebar" class="w-0 bg-slate-800 dark:bg-slate-900 text-white flex flex-col shrink-0 transition-all duration-300 overflow-hidden no-print">
            <div class="p-5 flex flex-col h-full w-64 shrink-0">
                <div class="flex items-center gap-3 mb-8">
                    <div class="bg-blue-600 p-2 rounded-xl font-black text-xs shrink-0 text-center">UCP</div>
                    <span class="font-black text-base tracking-tighter uppercase block leading-none whitespace-nowrap text-left">Portal Central</span>
                </div>
                <nav id="sidebar-nav" class="flex-1 space-y-1 overflow-y-auto no-scrollbar text-left"></nav>
                <div class="pt-4 border-t border-slate-700/50">
                    <div id="sidebar-user-card" class="flex flex-col gap-2 mb-4 p-3 bg-slate-700/30 dark:bg-slate-800/50 rounded-xl relative text-left">
                        <div class="flex items-center gap-3">
                            <div id="user-initial" class="w-9 h-9 rounded-lg bg-blue-600 flex items-center justify-center font-black text-base shadow-inner text-white uppercase shrink-0 text-center">?</div>
                            <div class="overflow-hidden text-left flex-1">
                                <p id="user-display-name" class="text-[10px] font-black truncate uppercase text-blue-100 italic">Usuario</p>
                                <p id="user-display-role" class="text-[8px] text-slate-400 uppercase font-bold tracking-tighter">Perfil</p>
                            </div>
                            <button onclick="openRoleSwitcher()" class="shrink-0 w-7 h-7 bg-slate-600 rounded-full flex items-center justify-center text-[10px] shadow-lg hover:bg-blue-500 transition-colors text-center text-center">üîÑ</button>
                        </div>
                        <button onclick="changeMyPassword()" class="w-full mt-2 py-1.5 bg-white/10 rounded-lg text-[8px] font-black uppercase tracking-widest border border-white/5 hover:bg-white/20 transition-all flex items-center justify-center gap-2 text-center text-center">
                            <span>üîë</span> Cambiar mi clave
                        </button>
                    </div>
                    <button id="btn-logout" onclick="window.location.reload()" class="w-full py-2.5 text-[9px] font-black text-red-400 hover:bg-red-500/10 rounded-lg uppercase tracking-widest border border-red-500/20 flex items-center justify-center gap-2 overflow-hidden text-center text-center">
                        <span class="text-sm">üö™</span> <span>Cerrar Sesi√≥n</span>
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-slate-50 dark:bg-slate-950 overflow-hidden relative text-left">
            <header class="h-14 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-6 shrink-0 no-print text-left">
                <div class="flex items-center gap-4 text-left">
                    <button onclick="toggleSidebar()" class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-md transition-colors text-center">
                        <span class="text-lg">‚ò∞</span>
                    </button>
                    <h2 id="view-title" class="text-base font-black text-slate-800 dark:text-white uppercase tracking-tighter italic text-left">Inicio</h2>
                </div>
                <div class="flex items-center gap-2 text-center">
                    <button onclick="toggleFullscreen()" class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-md transition-colors text-center text-center">
                        <span id="full-icon">‚õ∂</span>
                    </button>
                    <button onclick="toggleTheme()" class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-md transition-colors text-center text-center">
                        <span id="theme-icon">üåô</span>
                    </button>
                </div>
            </header>
            <div id="content-area" class="flex-1 overflow-y-auto p-6 no-scrollbar dark:bg-slate-950 text-left"></div>
        </main>
    </div>

    <div id="modal-scanner" class="hidden fixed inset-0 z-[120] bg-slate-900/95 backdrop-blur-md flex flex-col items-center justify-center p-4 text-center">
        <div class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-[2.5rem] overflow-hidden shadow-2xl text-center">
            <div class="p-5 bg-blue-600 text-white flex justify-between items-center text-left text-left">
                <span class="font-black uppercase text-xs tracking-widest text-left">Escaneo Activo</span>
                <div class="flex gap-2">
                    <button id="btn-torch" onclick="toggleTorch()" class="p-2 bg-white/20 rounded-full text-sm text-center">‚ö°</button>
                    <button onclick="stopScanner()" class="p-2 bg-white/20 rounded-full text-center">‚úï</button>
                </div>
            </div>
            <div class="p-6 text-center text-center text-center"><div id="reader"></div></div>
        </div>
    </div>

    <script>
        const ROLES = { ADMIN: 'ADMINISTRADOR', DIP: 'DEPARTAMENTO INSPECCI√ìN PENITENCIARIA', UCP: 'UNIDAD DE CONTROL PENITENCIARIO' };
        const PROFILES = ['PERSONAL', 'MOVIL', 'MONOTRIBUTISTA', 'DOCENTE', 'ABOGADO', 'PASTORAL', 'VISITA', 'OTROS'];
        let currentUser = null, activeRole = null, html5QrCode = null;
        let isSidebarOpen = false, isTorchOn = false;
        let viewHistory = [];
        window.currentViewId = 'dashboard';

        function toggleSidebar() {
            isSidebarOpen = !isSidebarOpen;
            const sidebar = document.getElementById('sidebar');
            if (isSidebarOpen) sidebar.classList.replace('w-0', 'w-64');
            else sidebar.classList.replace('w-64', 'w-0');
        }

        function showMessage(text, type = 'info') {
            const wrapper = document.getElementById('toast-wrapper');
            const toast = document.createElement('div');
            const colors = { 'info': 'bg-blue-600', 'success': 'bg-emerald-600', 'error': 'bg-red-600' };
            toast.className = `${colors[type]} text-white px-5 py-3 rounded-2xl shadow-xl font-black text-[10px] uppercase animate-fade-in pointer-events-auto text-center`;
            toast.innerText = text; wrapper.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }

        let deleteAction = null;
        function openConfirmModal(title, action) {
            document.getElementById('confirm-text').innerText = title;
            document.getElementById('confirm-modal').classList.remove('hidden');
            document.getElementById('confirm-stage-1').classList.remove('hidden');
            document.getElementById('confirm-stage-2').classList.add('hidden');
            deleteAction = action;
        }
        function closeConfirmModal() { document.getElementById('confirm-modal').classList.add('hidden'); deleteAction = null; }
        function stageConfirm(stage) {
            if (stage === 2) {
                document.getElementById('confirm-stage-1').classList.add('hidden');
                document.getElementById('confirm-stage-2').classList.remove('hidden');
                document.getElementById('final-confirm-btn').onclick = async () => {
                    if (deleteAction) await deleteAction();
                    closeConfirmModal();
                };
            }
        }

        function setUploadProgress(show, current = 0, total = 0) {
            const overlay = document.getElementById('upload-overlay');
            const bar = document.getElementById('upload-bar');
            const count = document.getElementById('upload-count');
            if (show) {
                overlay.classList.remove('hidden');
                const pct = Math.round((current / total) * 100) || 0;
                bar.style.width = pct + '%';
                count.innerText = `${current} / ${total} registros (${pct}%)`;
            } else { overlay.classList.add('hidden'); }
        }

        function initUI() {
            document.getElementById('login-box').innerHTML = `
                <div class="bg-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6 text-white font-black text-2xl shadow-xl text-center">SP</div>
                <h1 class="text-xl font-black text-slate-800 dark:text-white uppercase mb-1 leading-none text-center">Control UCP</h1>
                <p class="text-[9px] font-bold text-slate-400 uppercase mb-8 tracking-[0.2em] text-center">Acceso Multi-Cloud SPC</p>
                <form id="login-form" class="space-y-3 mx-auto max-w-xs text-center" onsubmit="event.preventDefault(); handleLogin();">
                    <div class="flex gap-2 text-center text-center">
                        <input type="text" id="username" class="flex-1 px-4 py-3.5 rounded-xl border-2 bg-slate-50 dark:bg-slate-900 dark:text-white dark:border-slate-700 font-black text-center text-lg outline-none text-center" placeholder="AFILIADO">
                        <button type="button" onclick="startScanner('LOGIN')" class="p-4 bg-slate-100 dark:bg-slate-700 dark:text-white rounded-xl text-center">üìü</button>
                    </div>
                    <input type="password" id="password" class="w-full px-4 py-3.5 rounded-xl border-2 bg-slate-50 dark:bg-slate-900 dark:text-white dark:border-slate-700 font-black text-center text-lg outline-none text-center" placeholder="CONTRASE√ëA">
                    <button type="submit" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg uppercase text-[10px] tracking-widest mt-4 hover:opacity-90 transition-all text-center">Entrar al Sistema</button>
                </form>
            `;
        }

        async function handleLogin() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value;
            if(u === '136219951' && p === 'Marquitos123') {
                currentUser = { fullName: 'MARCOS GUTI√âRREZ', username: '136219951', role: ROLES.ADMIN };
                startSession(ROLES.ADMIN); return;
            }
            const user = window.SYSTEM_USERS.find(x => x.id === u && x.password === p);
            if(user) {
                currentUser = { fullName: user.fullName, username: user.id, role: user.role };
                startSession(user.role);
            } else showMessage("Credenciales incorrectas", "error");
        }

        function openRoleSwitcher() {
            const container = document.getElementById('role-options');
            let roles = currentUser.role === ROLES.ADMIN ? [ROLES.ADMIN, ROLES.DIP, ROLES.UCP] : (currentUser.role === ROLES.DIP ? [ROLES.DIP, ROLES.UCP] : [ROLES.UCP]);
            container.innerHTML = roles.map(role => `
                <button onclick="startSession('${role}')" class="w-full py-4 bg-slate-100 dark:bg-slate-700 dark:text-white hover:bg-blue-600 hover:text-white transition-all rounded-2xl font-black uppercase text-xs tracking-widest shadow-sm text-center">
                    ${role}
                </button>
            `).join('');
            document.getElementById('role-screen').classList.remove('hidden');
        }

        function startSession(role) {
            activeRole = role; document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('role-screen').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('user-display-name').innerText = currentUser.fullName; document.getElementById('user-display-role').innerText = activeRole;
            document.getElementById('user-initial').innerText = currentUser.fullName.split(' ').map(n => n[0]).join('').toUpperCase();
            buildMenu(); viewHistory = []; renderView('dashboard', 'Inicio');
        }

        function buildMenu() {
            const nav = document.getElementById('sidebar-nav');
            const items = [
                { id: 'dashboard', label: 'DASHBOARD GLOBAL', icon: 'üìä' },
                { id: 'ingresos', label: 'REGISTRO INGRESOS', icon: 'üìù' },
                { id: 'importar_personal', label: 'PERSONAL', icon: 'üë•' },
                { id: 'importar_body', label: 'BODY SCAN', icon: 'üîç' },
                { id: 'reportes', label: 'REPORTES & AUDITOR√çA', icon: 'üìã' },
                { id: 'users_admin', label: 'GESTI√ìN USUARIOS', icon: '‚öôÔ∏è' }
            ];
            nav.innerHTML = items.map(item => `
                <button onclick="renderView('${item.id}', '${item.label}')" class="w-full flex items-center gap-3 px-3 py-3 text-[10px] font-black rounded-xl hover:bg-slate-700 transition-all uppercase text-left group text-left">
                    <span class="text-base group-hover:scale-110 transition-transform text-center">${item.icon}</span> 
                    <span class="whitespace-nowrap text-left">${item.label}</span>
                </button>`).join('');
        }

        function renderView(viewId, title, isBack = false) {
            if (!isBack) {
                viewHistory.push({ id: viewId, label: title });
                history.pushState({ viewId, label: title }, title);
            }
            window.currentViewId = viewId; document.getElementById('view-title').innerText = title;
            const content = document.getElementById('content-area');
            if (isSidebarOpen) toggleSidebar();

            if (viewId === 'dashboard') {
                content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in text-left text-left">
                    <div class="bg-white dark:bg-slate-900/50 p-8 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm backdrop-blur-sm text-left">
                        <p class="text-[9px] font-black text-blue-500 uppercase mb-1 italic text-left">Agentes SPC</p>
                        <p class="text-4xl font-black dark:text-white text-left" id="dash-total-personal">${window.PERSONAL_DB.length}</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900/50 p-8 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm backdrop-blur-sm text-left">
                        <p class="text-[9px] font-black text-emerald-500 uppercase mb-1 italic text-left">Pases Body Scan</p>
                        <p class="text-4xl font-black dark:text-white text-left" id="dash-total-body">${window.pasesBodyData.length}</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900/50 p-8 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm backdrop-blur-sm text-left">
                        <p class="text-[9px] font-black text-amber-500 uppercase mb-1 italic text-left">Ingresos Totales</p>
                        <p class="text-4xl font-black dark:text-white text-left" id="dash-total-ingresos">${window.ingresosRecientes.length}</p>
                    </div>
                </div>`;
            } else if (viewId === 'ingresos') renderIngresosView(content);
            else if (viewId === 'reportes') renderReportesView(content);
            else if (viewId === 'users_admin') renderUsersAdminView(content);
            else if (viewId === 'importar_personal') {
                content.innerHTML = renderImportModule("Personal", "personal-file", "processPersonalFile(this)", "Fecha de √∫ltima importaci√≥n", window.importStats.personal.date, window.PERSONAL_DB.length, "uploadPersonal()");
            } else if (viewId === 'importar_body') {
                content.innerHTML = renderImportModule("Body Scan", "body-file", "processBodyFile(this)", "√öltima marca temporal", "-", window.pasesBodyData.length, "uploadBody()");
            }
        }

        function renderIngresosView(container) {
            const now = new Date();
            container.innerHTML = `
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 animate-fade-in text-left text-left">
                <div class="xl:col-span-5 text-left">
                    <div class="bg-white dark:bg-slate-900/50 p-8 rounded-[3rem] shadow-xl border border-slate-200 dark:border-slate-800 text-left backdrop-blur-sm text-left text-left">
                        <form id="ingreso-form" class="space-y-4 text-left" onsubmit="event.preventDefault(); handleSaveIngreso();">
                            <div class="grid grid-cols-2 gap-3 text-left">
                                <input type="date" id="ing-fecha" value="${now.toISOString().split('T')[0]}" class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none text-left">
                                <input type="time" id="ing-hora" value="${now.toTimeString().split(' ')[0].substring(0, 5)}" class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none text-left">
                            </div>
                            <select id="ing-perfil" onchange="updateDynamicFields(this.value)" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs uppercase outline-none text-left">
                                <option value="" disabled selected>PERFIL DE ACCESO</option>
                                ${PROFILES.map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                            <div id="dyn-fields" class="space-y-4 text-left"></div>
                            <div class="flex gap-2 text-center text-center">
                                <button type="button" onclick="setMode('PEAT√ìN')" id="btn-p" class="flex-1 py-3 border-2 dark:border-slate-700 rounded-xl text-xl bg-white dark:bg-slate-800 transition-colors text-center">üö∂</button>
                                <button type="button" onclick="setMode('VEH√çCULO')" id="btn-v" class="flex-1 py-3 border-2 dark:border-slate-700 rounded-xl text-xl bg-white dark:bg-slate-800 transition-colors text-center">üöó</button>
                            </div>
                            <div id="vehicle-fields" class="hidden text-center"><input type="text" id="ing-dominio" class="w-full px-4 py-3 bg-blue-50 dark:bg-blue-900/20 dark:text-white border-2 border-blue-200 rounded-xl text-center text-lg font-black outline-none" placeholder="PATENTE / MOVIL"></div>
                            <input type="hidden" id="ing-modo" value="">
                            <textarea id="ing-obs" rows="2" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none text-left" placeholder="OBSERVACIONES / DESTINO"></textarea>
                            <button type="submit" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg uppercase text-[10px] tracking-widest transition-all hover:opacity-90 text-center text-center">Registrar Movimiento</button>
                        </form>
                    </div>
                </div>
                <div class="xl:col-span-7 bg-white dark:bg-slate-900/50 rounded-[3rem] border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col overflow-hidden text-left backdrop-blur-sm text-left">
                    <div class="p-4 bg-slate-50 dark:bg-slate-800/80 font-black text-[9px] uppercase italic text-slate-400 text-left">Panel Reciente</div>
                    <div class="flex-1 overflow-auto no-scrollbar text-left"><table class="w-full text-[11px] text-left text-left"><tbody id="ingresos-table" class="divide-y dark:divide-slate-800 text-left"></tbody></table></div>
                </div>
            </div>`;
            window.updateIngresosTable();
        }

        function renderReportesView(container) {
            const canDelete = activeRole === ROLES.DIP || activeRole === ROLES.ADMIN;
            container.innerHTML = `
            <div class="bg-white dark:bg-slate-900/50 p-8 rounded-[3rem] border border-slate-200 dark:border-slate-800 shadow-sm h-full flex flex-col text-left backdrop-blur-sm text-left text-left">
                <div class="flex flex-wrap justify-between items-center gap-4 mb-6 no-print text-left text-left">
                    <div class="flex items-center gap-4 text-left">
                        <h3 class="font-black uppercase italic text-sm dark:text-white text-left">Auditor√≠a Inteligente</h3>
                        ${canDelete ? `<button onclick="handleDeleteByDay()" class="bg-red-600/10 text-red-600 border border-red-600 px-4 py-2 rounded-xl font-black text-[8px] uppercase hover:bg-red-600 hover:text-white transition-all text-center">Eliminar D√≠a Seleccionado</button>` : ''}
                    </div>
                    <div class="flex gap-2 text-center text-center">
                        <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-5 py-2.5 rounded-xl font-black text-[9px] uppercase text-center text-center">Excel</button>
                        <button onclick="window.print()" class="bg-blue-600 text-white px-5 py-2.5 rounded-xl font-black text-[9px] uppercase text-center text-center">Generar PDF</button>
                    </div>
                </div>

                <div id="report-header-print" class="hidden print-header-info text-left">
                    <h1 class="text-xl font-black uppercase mb-1">UNIDAD DE CONTROL PENITENCIARIO</h1>
                    <p class="text-[10px] font-black uppercase text-slate-600" id="report-filter-summary">REPORTE DE INGRESOS</p>
                    <p class="text-[8px] font-bold text-slate-400">GENERADO: ${new Date().toLocaleString()}</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 p-5 bg-slate-50 dark:bg-slate-800/80 rounded-3xl mb-6 no-print text-left">
                    <input type="text" id="filter-search" oninput="updateFullReport()" placeholder="BUSQUEDA..." class="md:col-span-2 px-4 py-2 rounded-xl border-2 dark:bg-slate-900 dark:text-white dark:border-slate-700 font-black text-[10px] outline-none text-left">
                    <input type="date" id="filter-start" onchange="updateFullReport()" class="px-4 py-2 rounded-xl border-2 dark:bg-slate-900 dark:text-white dark:border-slate-700 font-black text-[10px] outline-none text-left">
                    <input type="date" id="filter-end" onchange="updateFullReport()" class="px-4 py-2 rounded-xl border-2 dark:bg-slate-900 dark:text-white dark:border-slate-700 font-black text-[10px] outline-none text-left text-left">
                </div>
                <div class="flex-1 overflow-auto no-scrollbar rounded-3xl border border-slate-200 dark:border-slate-800 text-left">
                    <table class="w-full text-[10px] text-left print-table text-left">
                        <thead class="bg-slate-50 dark:bg-slate-800 font-black uppercase text-[8px] sticky top-0 dark:text-slate-400 text-left">
                            <tr>
                                <th class="p-3 text-left">FECHA/HORA</th>
                                <th class="p-3 text-left">IDENTIFICACI√ìN Y SUJETO</th>
                                <th class="p-3 text-left">PERFIL</th>
                                <th class="p-3 text-right">OP.</th>
                                ${canDelete ? `<th class="p-3 text-center no-print">ACCI√ìN</th>` : ''}
                            </tr>
                        </thead>
                        <tbody id="full-report-table" class="divide-y dark:divide-slate-800 font-medium text-left"></tbody>
                    </table>
                </div>
            </div>`;
            window.updateFullReport();
        }

        window.updateFullReport = () => {
            const b = document.getElementById('full-report-table'); if(!b) return;
            const search = document.getElementById('filter-search').value.toUpperCase();
            const start = document.getElementById('filter-start').value, end = document.getElementById('filter-end').value;
            const canDelete = activeRole === ROLES.DIP || activeRole === ROLES.ADMIN;

            const filtered = window.ingresosRecientes.filter(i => {
                const ms = !search || [i.sujeto, i.nomSujeto, i.obs, i.dominio, i.matProf].some(f => f && String(f).toUpperCase().includes(search));
                const md = (!start || i.fecha >= start) && (!end || i.fecha <= end);
                return ms && md;
            });

            b.innerHTML = filtered.map(i => {
                let displaySubject = "";
                if (i.perfil === 'PERSONAL' || i.perfil === 'MOVIL') {
                    displaySubject = `AFILIADO N¬∞ ${i.sujeto} Y ${i.nomSujeto}`;
                } else {
                    displaySubject = `DNI ${i.sujeto}, ${i.nomSujeto}`;
                    if (i.perfil === 'ABOGADO' && i.matProf) {
                        displaySubject += ` <span class="text-blue-600 font-black">MP:${i.matProf}</span>`;
                    }
                }

                let vehicleLine = "";
                if (i.dominio) {
                    const label = (i.perfil === 'MOVIL' || i.perfil === 'PERSONAL') ? 'MOVIL' : 'DOMINIO';
                    vehicleLine = `<div class="text-[7pt] text-slate-400 dark:text-slate-500 font-black italic mt-0.5">${label} ${i.dominio}</div>`;
                }

                return `
                <tr class="font-bold text-slate-600 dark:text-slate-400 text-left text-left">
                    <td class="p-2 border-b border-slate-200 dark:border-slate-800 text-left">${i.fecha}<br><span class="text-blue-500 text-[8px]">${i.hora}</span></td>
                    <td class="p-2 border-b border-slate-200 dark:border-slate-800 uppercase dark:text-slate-300 text-left">
                        <div class="leading-tight">${displaySubject}</div>
                        ${vehicleLine}
                    </td>
                    <td class="p-2 border-b border-slate-200 dark:border-slate-800 text-blue-500 uppercase text-left">${i.perfil}</td>
                    <td class="p-2 border-b border-slate-200 dark:border-slate-800 text-[8px] font-black text-right">${window.getOpCode(i.operador)}</td>
                    ${canDelete ? `<td class="p-2 border-b border-slate-200 dark:border-slate-800 text-center no-print"><button onclick="handleDeleteIngreso('${i.id}')" class="p-1.5 text-red-500 hover:bg-red-50 rounded-lg transition-colors text-center text-center">üóëÔ∏è</button></td>` : ''}
                </tr>`;
            }).join('');
        };

        window.handleDeleteIngreso = (id) => {
            openConfirmModal("¬øDesea eliminar este registro individual?", async () => {
                try {
                    await fbDeleteDoc(fbDoc(fbDbRegistros, 'artifacts', 'ucp-registros', 'public', 'data', 'ingresos', id));
                    showMessage("Eliminado", "success");
                } catch(e) { showMessage("Error", "error"); }
            });
        };

        window.handleDeleteByDay = () => {
            const date = document.getElementById('filter-start').value;
            if(!date) return showMessage("Filtre por fecha de inicio para eliminar", "error");
            openConfirmModal(`¬øELIMINAR TODOS LOS REGISTROS DEL D√çA ${date}?`, async () => {
                const toDelete = window.ingresosRecientes.filter(i => i.fecha === date);
                if(!toDelete.length) return showMessage("Sin registros en esa fecha", "info");
                const batch = fbWriteBatch(fbDbRegistros);
                toDelete.forEach(i => batch.delete(fbDoc(fbDbRegistros, 'artifacts', 'ucp-registros', 'public', 'data', 'ingresos', i.id)));
                await batch.commit(); showMessage("D√≠a depurado con √©xito", "success");
            });
        };

        function renderUsersAdminView(container) {
            container.innerHTML = `
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 animate-fade-in text-left text-left">
                <div class="xl:col-span-4 text-left">
                    <div class="bg-white dark:bg-slate-900/50 p-8 rounded-[3rem] shadow-xl border border-slate-200 dark:border-slate-800 text-left backdrop-blur-sm text-left text-left">
                        <h3 class="text-xs font-black uppercase italic mb-6 dark:text-white text-center">Alta Operador</h3>
                        <form id="user-form" class="space-y-4 mx-auto text-center" onsubmit="event.preventDefault(); handleSaveUser();">
                            <input type="text" id="user-id" oninput="window.lookupPersonalForUser(this.value)" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none text-left" placeholder="MATR√çCULA / AFILIADO">
                            <input type="text" id="user-name" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none text-left" placeholder="APELLIDO Y NOMBRE">
                            <input type="password" id="user-pass" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none text-left" placeholder="CLAVE">
                            <select id="user-role" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs uppercase outline-none text-left">
                                <option value="${ROLES.UCP}">${ROLES.UCP}</option>
                                <option value="${ROLES.DIP}">${ROLES.DIP}</option>
                                ${activeRole === ROLES.ADMIN ? `<option value="${ROLES.ADMIN}">${ROLES.ADMIN}</option>` : ''}
                            </select>
                            <button type="submit" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg uppercase text-[10px] text-center text-center">Crear</button>
                        </form>
                    </div>
                </div>
                <div class="xl:col-span-8 bg-white dark:bg-slate-900/50 rounded-[3rem] border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden flex flex-col text-left backdrop-blur-sm text-left">
                    <div class="p-4 bg-slate-50 dark:bg-slate-800/80 font-black text-[9px] uppercase italic text-slate-400 text-left">Listado de Personal</div>
                    <div class="flex-1 overflow-auto no-scrollbar text-left"><table class="w-full text-left text-[11px] text-left text-left"><tbody id="users-table-body" class="divide-y dark:divide-slate-800 text-left"></tbody></table></div>
                </div>
            </div>`; window.refreshUsersList();
        }

        window.lookupPersonalForUser = (val) => {
            const id = val.trim().toUpperCase(); if(!id) return;
            const agent = window.PERSONAL_DB.find(a => String(a.id).toUpperCase() === id);
            const nameField = document.getElementById('user-name');
            if(agent && nameField) nameField.value = agent.apellidoNombre.toUpperCase();
        };

        window.refreshUsersList = () => {
            const body = document.getElementById('users-table-body'); if(!body) return;
            let list = window.SYSTEM_USERS;
            body.innerHTML = list.map(u => {
                const canReset = (activeRole === ROLES.ADMIN) || 
                                 (activeRole === ROLES.DIP && u.role === ROLES.UCP);
                
                return `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 text-left text-left">
                    <td class="p-4 border-b border-slate-200 dark:border-slate-800 text-left">
                        <div class="font-black uppercase text-[10px] dark:text-white">${u.fullName}</div>
                        <div class="text-[8px] text-slate-400 font-bold uppercase">${u.role} | ID: ${u.id}</div>
                    </td>
                    <td class="p-4 border-b border-slate-200 dark:border-slate-800 text-right">
                        ${canReset ? `<button onclick="resetPass('${u.id}')" class="p-2 text-blue-500 text-center">üîë</button>` : ''}
                        ${(activeRole === ROLES.ADMIN) ? `<button onclick="deleteUser('${u.id}')" class="p-2 text-red-500 text-center">üóëÔ∏è</button>` : ''}
                    </td>
                </tr>`;
            }).join('');
        };

        window.resetPass = async (id) => {
            const n = prompt("Nueva clave para " + id + ":");
            if(n) {
                try {
                    await fbUpdateDoc(fbDoc(fbDbRegistros, 'artifacts', 'ucp-registros', 'public', 'data', 'users', id), { password: n });
                    showMessage("Blanqueo exitoso", "success");
                } catch(e) { showMessage("Error", "error"); }
            }
        };

        window.changeMyPassword = async () => {
            if(!currentUser) return;
            const n = prompt("Ingrese su nueva clave personal:");
            if(n) {
                try {
                    await fbUpdateDoc(fbDoc(fbDbRegistros, 'artifacts', 'ucp-registros', 'public', 'data', 'users', currentUser.username), { password: n });
                    showMessage("Clave actualizada", "success");
                } catch(e) { showMessage("Error de conexi√≥n", "error"); }
            }
        };

        window.deleteUser = async (id) => { if(confirm("¬øEliminar operador?")) { try { await fbDeleteDoc(fbDoc(fbDbRegistros, 'artifacts', 'ucp-registros', 'public', 'data', 'users', id)); showMessage("Eliminado", "success"); } catch(e) {} } };

        window.getOpCode = (opId) => {
            if(!opId) return "-";
            const op = window.SYSTEM_USERS.find(u => u.id === opId);
            if(!op) return opId.slice(-3);
            const initials = op.fullName.split(' ').map(n => n[0]).join('').toUpperCase();
            return initials + opId.slice(-3);
        };

        window.toggleTorch = async () => {
            if (!html5QrCode) return;
            try {
                isTorchOn = !isTorchOn;
                await html5QrCode.applyVideoConstraints({ advanced: [{ torch: isTorchOn }] });
                document.getElementById('btn-torch').classList.toggle('bg-amber-400', isTorchOn);
            } catch (e) { showMessage("Fallo linterna", "info"); }
        };

        window.startScanner = (type) => {
            document.getElementById('modal-scanner').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            isTorchOn = false;
            html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, (t) => {
                const parts = t.split('@'); const atCount = parts.length - 1;
                if (atCount >= 7 && atCount <= 9) {
                    const dni = parts[4]?.trim() || ""; const apellido = parts[1]?.trim() || ""; const nombre = parts[2]?.trim() || "";
                    stopScanner(); 
                    const inputSujeto = document.getElementById('ing-dni') || document.getElementById('ing-mat');
                    const inputNom = document.getElementById('ing-nom');
                    if(inputSujeto) { inputSujeto.value = dni; window.searchPersonalInDB(dni); }
                    if(inputNom) { inputNom.value = `${apellido} ${nombre}`.trim().toUpperCase(); }
                    return;
                }
                stopScanner(); if(type === 'LOGIN') document.getElementById('username').value = t;
                else { const i = document.getElementById('ing-dni') || document.getElementById('ing-mat'); if(i) { i.value = t; window.searchPersonalInDB(t); } }
            }, () => {} ).catch(() => stopScanner());
        };

        window.stopScanner = () => { if(html5QrCode) html5QrCode.stop().finally(() => { document.getElementById('modal-scanner').classList.add('hidden'); html5QrCode = null; }); else document.getElementById('modal-scanner').classList.add('hidden'); };

        window.updateDynamicFields = (perfil) => {
            const container = document.getElementById('dyn-fields'); if(!container) return;
            if (perfil === 'PERSONAL' || perfil === 'MOVIL') {
                container.innerHTML = `
                <div class="flex gap-2 w-full text-left">
                    <input type="text" id="ing-mat" oninput="window.searchPersonalInDB(this.value)" class="flex-1 px-4 py-3 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none text-left" placeholder="MATR√çCULA / AFILIADO">
                    <button type="button" onclick="startScanner('SUJETO')" class="p-3 bg-slate-100 dark:bg-slate-700 rounded-xl hover:bg-blue-600 transition-colors shrink-0 text-center text-center">üìü</button>
                </div>
                <div id="crossover-preview" class="hidden w-full p-5 bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-900/30 rounded-[2rem] animate-fade-in text-left">
                    <p id="prev-name" class="font-black text-blue-800 dark:text-blue-300 uppercase text-xs mb-1"></p>
                    <p id="prev-cargo" class="font-bold text-slate-500 dark:text-slate-400 uppercase text-[9px] mb-3"></p>
                    <div class="flex justify-between items-center bg-white dark:bg-slate-900/50 p-3 rounded-xl border border-slate-200 dark:border-blue-900/30 mb-3 text-left">
                        <span class="text-[9px] font-black uppercase text-slate-400 text-left">Pases Body Scan (60d)</span>
                        <span id="prev-body-count" class="bg-blue-600 text-white px-3 py-1 rounded-lg font-black text-xs text-center text-center">0</span>
                    </div>
                    <div id="prev-body-history" class="max-h-56 overflow-y-auto no-scrollbar space-y-1 text-left"></div>
                </div>`;
            } else if (perfil === 'ABOGADO') {
                container.innerHTML = `
                <div class="flex gap-2 w-full text-left">
                    <input type="text" id="ing-dni" class="flex-1 px-4 py-3 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none text-left" placeholder="DNI">
                    <button type="button" onclick="startScanner('SUJETO')" class="p-3 bg-slate-100 dark:bg-slate-700 rounded-xl hover:bg-blue-600 transition-colors shrink-0 text-center text-center">üì∏</button>
                </div>
                <input type="text" id="ing-nom" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none text-left" placeholder="APELLIDO Y NOMBRE">
                <input type="text" id="ing-mat-prof" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none text-left" placeholder="MATR√çCULA PROFESIONAL">`;
            } else {
                container.innerHTML = `
                <div class="flex gap-2 w-full text-left">
                    <input type="text" id="ing-dni" class="flex-1 px-4 py-3 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none text-left" placeholder="DNI">
                    <button type="button" onclick="startScanner('SUJETO')" class="p-3 bg-slate-100 dark:bg-slate-700 rounded-xl hover:bg-blue-600 transition-colors shrink-0 text-center text-center">üì∏</button>
                </div>
                <input type="text" id="ing-nom" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none text-left" placeholder="APELLIDO Y NOMBRE">`;
            }
        };

        window.searchPersonalInDB = (val) => {
            const id = val.trim().toUpperCase(); const p = document.getElementById('crossover-preview'); if(!id || !p) { if(p) p.classList.add('hidden'); return; }
            const agent = window.PERSONAL_DB.find(x => String(x.id).toUpperCase() === id);
            const sixtyDaysAgo = Date.now() - (60 * 24 * 60 * 60 * 1000);
            const pases = window.pasesBodyData.filter(x => String(x.matricula).toUpperCase() === id && (x.timestamp || 0) > sixtyDaysAgo);
            if (agent || pases.length > 0) {
                p.classList.remove('hidden'); 
                document.getElementById('prev-name').innerText = agent ? agent.apellidoNombre : 'ID SIN NOMBRE';
                document.getElementById('prev-cargo').innerText = agent ? agent.jerarquia : 'MATRICULA EXTERNA'; 
                document.getElementById('prev-body-count').innerText = pases.length;
                const h = document.getElementById('prev-body-history');
                if(h) {
                    const sorted = [...pases].sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
                    h.innerHTML = sorted.length > 0 ? sorted.map(px => `
                        <div class="flex justify-between items-center p-3 bg-white/50 dark:bg-slate-900/50 rounded-xl text-[8px] border border-blue-200 dark:border-blue-900/30 animate-fade-in text-left">
                            <span class="font-black text-blue-800 dark:text-blue-300 text-left">${px.fechaHora}</span>
                            <span class="font-bold text-slate-500 dark:text-slate-400 text-right">${px.sector || 'S/D'}</span>
                        </div>`).join('') : '<p class="text-[8px] text-center italic text-slate-400 py-4">Sin pases registrados en 60 d√≠as</p>';
                }
            } else p.classList.add('hidden');
        };

        async function handleSaveIngreso() {
            const p = document.getElementById('ing-perfil').value, m = document.getElementById('ing-modo').value, s = (document.getElementById('ing-dni')?.value || document.getElementById('ing-mat')?.value || "").trim();
            if(!p || !s || !m) return showMessage("Faltan datos", "error");
            const data = { fecha: document.getElementById('ing-fecha').value, hora: document.getElementById('ing-hora').value, perfil: p, modo: m, sujeto: s.toUpperCase(), nomSujeto: (document.getElementById('ing-nom')?.value || document.getElementById('prev-name')?.innerText || "").toUpperCase(), matProf: (document.getElementById('ing-mat-prof')?.value || "").toUpperCase(), obs: document.getElementById('ing-obs').value.toUpperCase(), dominio: (document.getElementById('ing-dominio')?.value || "").toUpperCase(), operador: currentUser.username, timestamp: Date.now() };
            try { await fbAddDoc(fbCollection(fbDbRegistros, 'artifacts', 'ucp-registros', 'public', 'data', 'ingresos'), data); showMessage("REGISTRADO", "success"); renderView('ingresos', 'REGISTRO INGRESOS'); } catch (e) { showMessage("Error Nube", "error"); }
        }

        window.updateIngresosTable = () => {
            const b = document.getElementById('ingresos-table'); if(!b) return;
            b.innerHTML = window.ingresosRecientes.slice(0, 15).map(i => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 text-left transition-colors text-left text-left">
                    <td class="p-4 font-black text-blue-500 dark:text-blue-400 border-b border-slate-200 dark:border-slate-800 text-left">${i.hora}</td>
                    <td class="p-4 border-b border-slate-200 dark:border-slate-800 font-black uppercase text-[10px] dark:text-slate-300 text-left">${i.nomSujeto || i.sujeto}</td>
                </tr>`).join('');
        };

        async function processPersonalFile(input) {
            if (!input.files.length) return; const file = input.files[0];
            const reader = new FileReader(); reader.onload = (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                window.pendingPersonal = rawData.map(row => ({ id: String(row.Matricula || row.MATRICULA || "").trim(), dni: String(row.DNI || "").trim(), jerarquia: String(row.Jerarquia || row.JERARQUIA || "").trim(), apellidoNombre: String(row['Apellido y Nombre'] || row.APELLIDO_Y_NOMBRE || "").trim() })).filter(p => p.id);
                const btn = document.getElementById('btn-upload-personal-file'); btn.disabled = false; btn.classList.remove('opacity-30'); btn.innerText = `Subir ${window.pendingPersonal.length}`;
            }; reader.readAsArrayBuffer(file);
        }

        async function processBodyFile(input) {
            if (!input.files.length) return; const file = input.files[0];
            const reader = new FileReader(); reader.onload = (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                const list = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]).map(row => ({ matricula: String(row.Matricula || row.MATRICULA || row.ID || "").trim(), nombre: String(row.Nombre || row.NOMBRE || "").trim(), fechaHora: String(row['Fecha y Hora'] || row.FECHA_HORA || "").trim(), sector: String(row.Sector || row.SECTOR || "S/D").trim(), timestamp: Date.now() })).filter(p => p.matricula);
                const existingKeys = new Set(window.pasesBodyData.map(p => `${p.matricula}|${p.fechaHora}`));
                window.pendingBody = list.filter(p => !existingKeys.has(`${p.matricula}|${p.fechaHora}`));
                const btn = document.getElementById('btn-upload-body-file'); btn.disabled = false; btn.classList.remove('opacity-30'); btn.innerText = `Subir ${window.pendingBody.length}`;
            }; reader.readAsArrayBuffer(file);
        }

        window.uploadPersonal = async () => {
            if (!window.pendingPersonal) return; const total = window.pendingPersonal.length; let current = 0; setUploadProgress(true, 0, total);
            const chunks = []; for (let i = 0; i < window.pendingPersonal.length; i += 400) chunks.push(window.pendingPersonal.slice(i, i + 400));
            for (const chunk of chunks) {
                const b = fbWriteBatch(window.fbDbPersonal); chunk.forEach(p => b.set(fbDoc(window.fbDbPersonal, 'artifacts', 'ucp-personal', 'public', 'data', 'personal', p.id), p, { merge: true }));
                await b.commit(); current += chunk.length; setUploadProgress(true, current, total);
            }
            window.importStats.personal.date = new Date().toLocaleString(); localStorage.setItem('ucp_import_stats', JSON.stringify(window.importStats));
            setUploadProgress(false); renderView('importar_personal', 'PERSONAL'); showMessage("Completado", "success");
        };

        window.uploadBody = async () => {
            if (!window.pendingBody) return; const total = window.pendingBody.length; let current = 0; setUploadProgress(true, 0, total);
            const chunks = []; for (let i = 0; i < window.pendingBody.length; i += 400) chunks.push(window.pendingBody.slice(i, i + 400));
            for (const chunk of chunks) {
                const b = fbWriteBatch(window.fbDbBody); chunk.forEach(p => b.set(fbDoc(fbCollection(window.fbDbBody, 'artifacts', 'ucp-body', 'public', 'data', 'pases_body')), p));
                await b.commit(); current += chunk.length; setUploadProgress(true, current, total);
            }
            window.importStats.body.date = new Date().toLocaleString(); localStorage.setItem('ucp_import_stats', JSON.stringify(window.importStats));
            setUploadProgress(false); renderView('importar_body', 'BODY SCAN'); showMessage("Completado", "success");
        };

        function renderImportModule(name, fileId, changeFn, labelStat, valStat, count, uploadFn) {
            return `
            <div class="max-w-xl mx-auto bg-white dark:bg-slate-900/50 p-10 rounded-[3rem] shadow-2xl border border-slate-200 dark:border-slate-800 animate-fade-in no-print text-left backdrop-blur-sm">
                <div class="w-20 h-20 bg-slate-50 dark:bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl shadow-inner text-center">üì•</div>
                <h2 class="text-xl font-black uppercase mb-1 italic dark:text-white text-center">${name}</h2>
                <div class="grid grid-cols-2 gap-3 my-8 text-left text-left">
                    <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 text-center">
                        <p class="text-[8px] font-black text-slate-400 uppercase mb-1 text-center">${labelStat}</p>
                        <p class="text-[10px] font-bold text-blue-600 dark:text-blue-400 text-center">${valStat}</p>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 text-center">
                        <p class="text-[8px] font-black text-slate-400 uppercase mb-1 text-center">Total</p>
                        <p class="text-[10px] font-bold text-emerald-600 dark:text-emerald-400 text-center">${count}</p>
                    </div>
                </div>
                <div class="space-y-4 text-left text-left">
                    <div class="border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-3xl p-8 bg-slate-50 dark:bg-slate-800 text-center">
                        <input type="file" id="${fileId}" class="hidden" onchange="${changeFn}">
                        <button onclick="document.getElementById('${fileId}').click()" class="bg-slate-200 dark:bg-slate-700 dark:text-white text-slate-800 font-black px-6 py-3 rounded-xl uppercase text-[9px] text-center text-center text-center">1. Elegir</button>
                    </div>
                    <button id="btn-upload-${fileId}" onclick="${uploadFn}" disabled class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg uppercase text-[10px] opacity-30 text-center text-center text-center text-center">2. Subir</button>
                </div>
            </div>`;
        }

        window.setMode = (m) => {
            document.getElementById('ing-modo').value = m;
            document.getElementById('btn-p').className = `flex-1 py-3 border-2 rounded-xl text-xl ${m==='PEAT√ìN'?'bg-blue-600 text-white border-blue-600 shadow-inner text-center':'bg-white dark:bg-slate-800 dark:border-slate-700 text-center'}`;
            document.getElementById('btn-v').className = `flex-1 py-3 border-2 rounded-xl text-xl ${m==='VEH√çCULO'?'bg-blue-600 text-white border-blue-600 shadow-inner text-center':'bg-white dark:bg-slate-800 dark:border-slate-700 text-center'}`;
            if(m==='VEH√çCULO') document.getElementById('vehicle-fields').classList.remove('hidden'); else document.getElementById('vehicle-fields').classList.add('hidden');
        };

        window.exportToExcel = () => { const ws = XLSX.utils.json_to_sheet(window.ingresosRecientes); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Auditoria"); XLSX.writeFile(wb, "Auditoria_UCP.xlsx"); };

        window.toggleTheme = () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeToggleIcon();
        };

        function updateThemeToggleIcon() {
            const icon = document.getElementById('theme-icon'); if(!icon) return;
            icon.innerText = document.documentElement.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
        }

        window.toggleFullscreen = () => {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        };
    </script>
</body>
</html>
