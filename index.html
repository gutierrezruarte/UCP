<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>U.C.P. - Portal de Control Integrado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <script>
        // Configuraci√≥n de Tailwind para usar estrategia de clase
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkBg: '#020617',
                        darkCard: '#0f172a'
                    }
                }
            }
        }

        // Aplicaci√≥n inmediata del tema
        const applyTheme = () => {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        };
        applyTheme();
    </script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, onSnapshot, writeBatch, query, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const configPersonal = { apiKey: "AIzaSyDly2M3_eGocS28O-EcO6FreL3be0wfZEE", authDomain: "ucp-personal.firebaseapp.com", projectId: "ucp-personal", appId: "1:715461905934:web:3e2dd5fe658ca5d61cb65f" };
        const configBody = { apiKey: "AIzaSyAUiha-utdBuHMe-pcQxeperw0pa3VlnHA", authDomain: "ucp-body.firebaseapp.com", projectId: "ucp-body", appId: "1:422629681048:web:007824b4fee476ac46aded" };
        const configRegistros = { apiKey: "AIzaSyBmvj542a67pQpa-2Ls5WJrun9OqlFH0Js", authDomain: "ucp-registros.firebaseapp.com", projectId: "ucp-registros", appId: "1:450418291282:web:b810cfcbf02df79708a58b" };

        const appP = initializeApp(configPersonal, "appPersonal");
        const appB = initializeApp(configBody, "appBody");
        const appR = initializeApp(configRegistros, "appRegistros");

        const authP = getAuth(appP); const authB = getAuth(appB); const authR = getAuth(appR);
        const dbP = getFirestore(appP); const dbB = getFirestore(appB); const dbR = getFirestore(appR);

        window.fbDbPersonal = dbP; window.fbDbBody = dbB; window.fbDbRegistros = dbR;
        window.fbAddDoc = addDoc; window.fbCollection = collection; window.fbDoc = doc; 
        window.fbWriteBatch = writeBatch; window.fbDeleteDoc = deleteDoc; window.fbUpdateDoc = updateDoc;
        window.fbSetDoc = setDoc;

        window.PERSONAL_DB = JSON.parse(localStorage.getItem('ucp_cache_personal') || '[]');
        window.pasesBodyData = JSON.parse(localStorage.getItem('ucp_cache_body') || '[]');
        window.ingresosRecientes = JSON.parse(localStorage.getItem('ucp_cache_ingresos') || '[]');
        window.SYSTEM_USERS = [];
        window.importStats = JSON.parse(localStorage.getItem('ucp_import_stats') || '{"personal": {"date": "-", "count": 0}, "body": {"date": "-", "count": 0}}');

        const initAuth = async () => {
            const loader = document.getElementById('global-loader');
            const authTask = async (authInst) => { try { await signInAnonymously(authInst); } catch (e) {} };
            await Promise.all([authTask(authP), authTask(authB), authTask(authR)]);
            if(loader) loader.remove();
        };

        onAuthStateChanged(authP, (user) => { if (user) {
            onSnapshot(collection(dbP, 'artifacts', 'ucp-personal', 'public', 'data', 'personal'), (snap) => {
                const data = []; snap.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                window.PERSONAL_DB = data; localStorage.setItem('ucp_cache_personal', JSON.stringify(data));
                updateUIStats();
            });
        }});

        onAuthStateChanged(authB, (user) => { if (user) {
            onSnapshot(collection(dbB, 'artifacts', 'ucp-body', 'public', 'data', 'pases_body'), (snap) => {
                const data = []; snap.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                window.pasesBodyData = data; localStorage.setItem('ucp_cache_body', JSON.stringify(data));
                updateUIStats();
            });
        }});

        onAuthStateChanged(authR, (user) => { if (user) {
            onSnapshot(collection(dbR, 'artifacts', 'ucp-registros', 'public', 'data', 'ingresos'), (snap) => {
                let data = []; snap.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                data.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                window.ingresosRecientes = data; localStorage.setItem('ucp_cache_ingresos', JSON.stringify(data.slice(0, 100)));
                if (window.updateIngresosTable) window.updateIngresosTable();
                if (window.updateFullReport) window.updateFullReport();
                updateUIStats();
            });
            onSnapshot(collection(dbR, 'artifacts', 'ucp-registros', 'public', 'data', 'users'), (snap) => {
                const data = []; snap.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                window.SYSTEM_USERS = data;
                if (window.refreshUsersList) window.refreshUsersList();
            });
        }});

        function updateUIStats() {
            const set = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
            set('dash-total-personal', window.PERSONAL_DB.length);
            set('dash-total-body', window.pasesBodyData.length);
            set('dash-total-ingresos', window.ingresosRecientes.length);
        }

        window.onload = () => { initAuth(); initUI(); updateThemeToggleIcon(); };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        
        .dark body { background-color: #020617 !important; color: #f1f5f9 !important; }
        .dark main { background-color: #020617 !important; }
        .dark #app-container { background-color: #020617 !important; }
        
        input[type="text"], textarea, select { text-transform: uppercase; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        @media print {
            aside, header, .no-print { display: none !important; }
            main { margin: 0 !important; padding: 0 !important; width: 100% !important; height: auto !important; }
            .print-report { display: block !important; width: 100% !important; font-size: 8pt !important; color: black !important; }
            .print-table { border-collapse: collapse; width: 100%; border: 1px solid #ddd; }
            .print-table th, .print-table td { border: 1px solid #ddd; padding: 4px; text-align: left; }
            .print-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        }
    </style>
</head>
<body class="h-full bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 overflow-hidden text-left">

    <div id="global-loader" class="fixed inset-0 z-[1000] bg-slate-900 flex flex-col items-center justify-center text-center">
        <div class="w-12 h-12 border-4 border-blue-600/20 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <h2 class="text-white font-black uppercase text-[10px] tracking-[0.3em]">Cruce de Datos SPC Activo</h2>
    </div>

    <!-- Indicador de Carga Firebase (Nuevo) -->
    <div id="upload-overlay" class="hidden fixed inset-0 z-[3000] bg-slate-950/80 backdrop-blur-sm flex flex-col items-center justify-center p-6 text-center">
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm p-8 rounded-[2.5rem] shadow-2xl border border-slate-200 dark:border-slate-700">
            <div class="w-10 h-10 border-4 border-blue-600/20 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
            <h3 class="text-xs font-black uppercase text-slate-800 dark:text-white mb-1 tracking-widest">Sincronizando Nube</h3>
            <p id="upload-status" class="text-[9px] font-bold text-slate-400 uppercase mb-4">Iniciando transferencia...</p>
            <div class="w-full bg-slate-100 dark:bg-slate-900 h-2 rounded-full overflow-hidden">
                <div id="upload-bar" class="bg-blue-600 h-full w-0 transition-all duration-300"></div>
            </div>
            <p id="upload-count" class="text-[8px] font-black text-blue-600 mt-2 uppercase">0 / 0 registros</p>
        </div>
    </div>

    <div id="toast-wrapper" class="fixed top-4 right-4 z-[2000] flex flex-col gap-2 pointer-events-none"></div>

    <!-- Selecci√≥n Rol -->
    <div id="role-screen" class="hidden fixed inset-0 z-[200] bg-slate-900/90 flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white dark:bg-slate-800 p-8 rounded-[2.5rem] shadow-2xl text-center">
            <h2 class="text-xl font-black uppercase tracking-tighter mb-1 dark:text-white italic text-center">Acceso Jer√°rquico</h2>
            <div id="role-options" class="grid grid-cols-1 gap-3 mt-6 text-center"></div>
        </div>
    </div>

    <!-- Pantalla Login -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-slate-50 dark:bg-slate-950 px-4 transition-colors">
        <div id="login-box" class="max-w-md w-full bg-white dark:bg-slate-800 p-8 rounded-[2.5rem] shadow-2xl text-center border border-slate-100 dark:border-slate-700"></div>
    </div>

    <div id="app-container" class="hidden h-full flex overflow-hidden dark:bg-slate-950">
        <aside id="sidebar" class="w-64 bg-slate-800 dark:bg-slate-900 text-white flex flex-col shrink-0 transition-all no-print">
            <div class="p-5 flex flex-col h-full">
                <div class="flex items-center gap-3 mb-8">
                    <div class="bg-blue-600 p-2 rounded-xl font-black text-xs">UCP</div>
                    <span class="font-black text-base tracking-tighter uppercase block leading-none">Portal Central</span>
                </div>
                <nav id="sidebar-nav" class="flex-1 space-y-1 overflow-y-auto no-scrollbar"></nav>
                <div class="pt-4 border-t border-slate-700/50">
                    <div class="flex items-center gap-3 mb-4 p-3 bg-slate-700/30 dark:bg-slate-800/50 rounded-xl relative text-left">
                        <div id="user-initial" class="w-9 h-9 rounded-lg bg-blue-600 flex items-center justify-center font-black text-base shadow-inner text-white uppercase font-black">?</div>
                        <div class="overflow-hidden text-left flex-1">
                            <p id="user-display-name" class="text-[10px] font-black truncate uppercase text-blue-100 italic">Usuario</p>
                            <p id="user-display-role" class="text-[8px] text-slate-400 uppercase font-bold tracking-tighter">Perfil</p>
                        </div>
                        <button id="btn-switch-role" onclick="openRoleSwitcher()" class="hidden absolute -top-2 -right-2 w-7 h-7 bg-blue-500 rounded-full border-2 border-slate-800 flex items-center justify-center text-[10px] shadow-lg hover:scale-110 transition-transform">üîÑ</button>
                    </div>
                    <button onclick="window.location.reload()" class="w-full py-2.5 text-[9px] font-black text-red-400 hover:bg-red-500/10 rounded-lg uppercase tracking-widest border border-red-500/20">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-slate-50 dark:bg-slate-950 overflow-hidden relative">
            <header class="h-14 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-6 shrink-0 no-print">
                <h2 id="view-title" class="text-base font-black text-slate-800 dark:text-white uppercase tracking-tighter italic">Inicio</h2>
                <div class="flex items-center gap-2">
                    <button onclick="toggleFullscreen()" title="Pantalla Completa" class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-md transition-colors">
                        <span id="full-icon">‚õ∂</span>
                    </button>
                    <button onclick="toggleTheme()" title="Cambiar Tema" class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-md transition-colors">
                        <span id="theme-icon">üåô</span>
                    </button>
                </div>
            </header>
            <div id="content-area" class="flex-1 overflow-y-auto p-6 no-scrollbar text-left dark:bg-slate-950"></div>
        </main>
    </div>

    <!-- Scanner Modal -->
    <div id="modal-scanner" class="hidden fixed inset-0 z-[120] bg-slate-900/95 backdrop-blur-md flex flex-col items-center justify-center p-4 no-print text-center">
        <div class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-[2.5rem] overflow-hidden shadow-2xl">
            <div class="p-5 bg-blue-600 text-white flex justify-between items-center">
                <span id="scanner-label" class="font-black uppercase text-xs tracking-widest">Escaneo Activo</span>
                <button onclick="stopScanner()" class="p-2 bg-white/20 rounded-full">‚úï</button>
            </div>
            <div class="p-6 text-center"><div id="reader"></div></div>
        </div>
    </div>

    <script>
        const ROLES = { ADMIN: 'ADMINISTRADOR', DIP: 'DEPARTAMENTO INSPECCI√ìN PENITENCIARIA', UCP: 'UNIDAD DE CONTROL PENITENCIARIO' };
        const PROFILES = ['PERSONAL', 'MOVIL', 'MONOTRIBUTISTA', 'DOCENTE', 'ABOGADO', 'PASTORAL', 'VISITA', 'OTROS'];
        let currentUser = null, activeRole = null, html5QrCode = null;
        
        function showMessage(text, type = 'info') {
            const wrapper = document.getElementById('toast-wrapper');
            const toast = document.createElement('div');
            const colors = { 'info': 'bg-blue-600', 'success': 'bg-emerald-600', 'error': 'bg-red-600' };
            toast.className = `${colors[type]} text-white px-5 py-3 rounded-2xl shadow-xl font-black text-[10px] uppercase animate-fade-in pointer-events-auto`;
            toast.innerText = text;
            wrapper.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }

        // --- Utilidades de Progreso ---
        function setUploadProgress(show, current = 0, total = 0) {
            const overlay = document.getElementById('upload-overlay');
            const bar = document.getElementById('upload-bar');
            const count = document.getElementById('upload-count');
            if (show) {
                overlay.classList.remove('hidden');
                const pct = Math.round((current / total) * 100) || 0;
                bar.style.width = pct + '%';
                count.innerText = `${current} / ${total} registros (${pct}%)`;
            } else {
                overlay.classList.add('hidden');
            }
        }

        function initUI() {
            document.getElementById('login-box').innerHTML = `
                <div class="bg-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6 text-white font-black text-2xl shadow-xl">SP</div>
                <h1 class="text-xl font-black text-slate-800 dark:text-white uppercase mb-1 leading-none text-center">Control UCP</h1>
                <p class="text-[9px] font-bold text-slate-400 uppercase mb-8 tracking-[0.2em] text-center">Acceso Multi-Cloud SPC</p>
                <form id="login-form" class="space-y-3" onsubmit="event.preventDefault(); handleLogin();">
                    <div class="flex gap-2 text-left">
                        <input type="text" id="username" class="flex-1 px-4 py-3.5 rounded-xl border-2 bg-slate-50 dark:bg-slate-900 dark:text-white dark:border-slate-700 font-black text-center text-lg outline-none" placeholder="AFILIADO">
                        <button type="button" onclick="startScanner('LOGIN')" class="p-4 bg-slate-100 dark:bg-slate-700 dark:text-white rounded-xl">üìü</button>
                    </div>
                    <input type="password" id="password" class="w-full px-4 py-3.5 rounded-xl border-2 bg-slate-50 dark:bg-slate-900 dark:text-white dark:border-slate-700 font-black text-center text-lg outline-none" placeholder="CONTRASE√ëA">
                    <button type="submit" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg uppercase text-[10px] tracking-widest mt-4 hover:opacity-90 transition-all">Entrar al Sistema</button>
                </form>
            `;
        }

        async function handleLogin() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value;
            if(u === '136219951' && p === 'Marquitos123') {
                currentUser = { fullName: 'MARCOS GUTI√âRREZ', username: '136219951', multiRole: true, role: ROLES.ADMIN };
                openRoleSwitcher(); return;
            }
            const user = window.SYSTEM_USERS.find(x => x.id === u && x.password === p);
            if(user) {
                currentUser = { fullName: user.fullName, username: user.id, multiRole: user.role === ROLES.ADMIN || user.role === ROLES.DIP, role: user.role };
                if (currentUser.multiRole) openRoleSwitcher(); else startSession(user.role);
            } else { showMessage("Credenciales incorrectas", "error"); }
        }

        function openRoleSwitcher() {
            const container = document.getElementById('role-options');
            let roles = currentUser.role === ROLES.ADMIN ? [ROLES.ADMIN, ROLES.DIP, ROLES.UCP] : (currentUser.role === ROLES.DIP ? [ROLES.DIP, ROLES.UCP] : [ROLES.UCP]);
            container.innerHTML = roles.map(role => `
                <button onclick="startSession('${role}')" class="w-full py-4 bg-slate-100 dark:bg-slate-700 dark:text-white hover:bg-blue-600 hover:text-white transition-all rounded-2xl font-black uppercase text-xs tracking-widest shadow-sm">
                    ${role}
                </button>
            `).join('');
            document.getElementById('role-screen').classList.remove('hidden');
        }

        function startSession(role) {
            activeRole = role;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('role-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('user-display-name').innerText = currentUser.fullName;
            document.getElementById('user-display-role').innerText = activeRole;
            document.getElementById('user-initial').innerText = currentUser.fullName.split(' ').map(n => n[0]).join('').toUpperCase();
            if (currentUser.multiRole) document.getElementById('btn-switch-role').classList.remove('hidden');
            buildMenu(); renderView('dashboard', 'Inicio');
        }

        function buildMenu() {
            const nav = document.getElementById('sidebar-nav');
            const items = [
                { id: 'dashboard', label: 'DASHBOARD GLOBAL', icon: 'üìä' },
                { id: 'ingresos', label: 'REGISTRO INGRESOS', icon: 'üìù' },
                { id: 'importar_personal', label: 'PERSONAL', icon: 'üë•' },
                { id: 'importar_body', label: 'BODY SCAN', icon: 'üîç' },
                { id: 'reportes', label: 'REPORTES & AUDITOR√çA', icon: 'üìã' },
                { id: 'users_admin', label: 'GESTI√ìN USUARIOS', icon: '‚öôÔ∏è' }
            ];
            nav.innerHTML = items.map(item => `
                <button onclick="renderView('${item.id}', '${item.label}')" class="w-full flex items-center gap-3 px-3 py-3 text-[10px] font-black rounded-xl hover:bg-slate-700 transition-all uppercase text-left group">
                    <span class="text-base group-hover:scale-110 transition-transform">${item.icon}</span> <span>${item.label}</span>
                </button>`).join('');
        }

        function renderView(viewId, title) {
            document.getElementById('view-title').innerText = title;
            const content = document.getElementById('content-area');
            if (viewId === 'dashboard') {
                content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in text-left no-print">
                    <div class="bg-white dark:bg-slate-900/50 p-8 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm backdrop-blur-sm">
                        <p class="text-[9px] font-black text-blue-500 uppercase mb-1 italic">Agentes SPC</p>
                        <p class="text-4xl font-black dark:text-white" id="dash-total-personal">${window.PERSONAL_DB.length}</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900/50 p-8 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm backdrop-blur-sm">
                        <p class="text-[9px] font-black text-emerald-500 uppercase mb-1 italic">Pases Body Scan</p>
                        <p class="text-4xl font-black dark:text-white" id="dash-total-body">${window.pasesBodyData.length}</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900/50 p-8 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm backdrop-blur-sm">
                        <p class="text-[9px] font-black text-amber-500 uppercase mb-1 italic">Ingresos Totales</p>
                        <p class="text-4xl font-black dark:text-white" id="dash-total-ingresos">${window.ingresosRecientes.length}</p>
                    </div>
                </div>`;
            } else if (viewId === 'ingresos') renderIngresosView(content);
            else if (viewId === 'reportes') renderReportesView(content);
            else if (viewId === 'users_admin') renderUsersAdminView(content);
            else if (viewId === 'importar_personal') content.innerHTML = renderImportModule("Personal", "ucp-personal", "personal-file", "processPersonalFile(this)", window.importStats.personal, "uploadPersonal()");
            else if (viewId === 'importar_body') content.innerHTML = renderImportModule("Body Scan", "ucp-body", "body-file", "processBodyFile(this)", window.importStats.body, "uploadBody()");
        }

        function renderIngresosView(container) {
            const now = new Date();
            container.innerHTML = `
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 animate-fade-in text-left no-print">
                <div class="xl:col-span-5">
                    <div class="bg-white dark:bg-slate-900/50 p-8 rounded-[3rem] shadow-xl border border-slate-200 dark:border-slate-800 text-left backdrop-blur-sm">
                        <form id="ingreso-form" class="space-y-4" onsubmit="event.preventDefault(); handleSaveIngreso();">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="date" id="ing-fecha" value="${now.toISOString().split('T')[0]}" class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none">
                                <input type="time" id="ing-hora" value="${now.toTimeString().split(' ')[0].substring(0, 5)}" class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none">
                            </div>
                            <select id="ing-perfil" onchange="updateDynamicFields(this.value)" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs uppercase outline-none">
                                <option value="" disabled selected>PERFIL DE ACCESO</option>
                                ${PROFILES.map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                            <div id="dyn-fields" class="space-y-4"></div>
                            <div class="flex gap-2">
                                <button type="button" onclick="setMode('PEAT√ìN')" id="btn-p" class="flex-1 py-3 border-2 dark:border-slate-700 rounded-xl text-xl bg-white dark:bg-slate-800 transition-colors">üö∂</button>
                                <button type="button" onclick="setMode('VEH√çCULO')" id="btn-v" class="flex-1 py-3 border-2 dark:border-slate-700 rounded-xl text-xl bg-white dark:bg-slate-800 transition-colors">üöó</button>
                            </div>
                            <div id="vehicle-fields" class="hidden"><input type="text" id="ing-dominio" class="w-full px-4 py-3 bg-blue-50 dark:bg-blue-900/20 dark:text-white border-2 border-blue-200 dark:border-blue-900/50 rounded-xl text-center text-lg font-black outline-none" placeholder="PATENTE"></div>
                            <input type="hidden" id="ing-modo" value="">
                            <textarea id="ing-obs" rows="2" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none" placeholder="OBSERVACIONES / DESTINO"></textarea>
                            <button type="submit" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg uppercase text-[10px] tracking-widest transition-all hover:opacity-90">Registrar Movimiento</button>
                        </form>
                    </div>
                </div>
                <div class="xl:col-span-7 bg-white dark:bg-slate-900/50 rounded-[3rem] border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col overflow-hidden text-left backdrop-blur-sm">
                    <div class="p-4 bg-slate-50 dark:bg-slate-800/80 font-black text-[9px] uppercase italic text-slate-400">Panel Reciente</div>
                    <div class="flex-1 overflow-auto no-scrollbar"><table class="w-full text-[11px] text-left"><tbody id="ingresos-table" class="divide-y dark:divide-slate-800"></tbody></table></div>
                </div>
            </div>`;
            window.updateIngresosTable();
        }

        function renderReportesView(container) {
            container.innerHTML = `
            <div class="bg-white dark:bg-slate-900/50 p-8 rounded-[3rem] border border-slate-200 dark:border-slate-800 shadow-sm h-full flex flex-col text-left backdrop-blur-sm">
                <div class="flex flex-wrap justify-between items-center gap-4 mb-6 no-print text-left text-left">
                    <h3 class="font-black uppercase italic text-sm dark:text-white">Auditor√≠a Inteligente</h3>
                    <div class="flex gap-2">
                        <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-5 py-2.5 rounded-xl font-black text-[9px] uppercase">Excel</button>
                        <button onclick="window.print()" class="bg-blue-600 text-white px-5 py-2.5 rounded-xl font-black text-[9px] uppercase">Generar PDF</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 p-5 bg-slate-50 dark:bg-slate-800/80 rounded-3xl mb-6 no-print">
                    <input type="text" id="filter-search" oninput="updateFullReport()" placeholder="BUSQUEDA..." class="md:col-span-2 px-4 py-2 rounded-xl border-2 dark:bg-slate-900 dark:text-white dark:border-slate-700 font-black text-[10px] outline-none">
                    <input type="date" id="filter-start" onchange="updateFullReport()" class="px-4 py-2 rounded-xl border-2 dark:bg-slate-900 dark:text-white dark:border-slate-700 font-black text-[10px] outline-none">
                    <input type="date" id="filter-end" onchange="updateFullReport()" class="px-4 py-2 rounded-xl border-2 dark:bg-slate-900 dark:text-white dark:border-slate-700 font-black text-[10px] outline-none">
                    <select id="filter-profile" onchange="updateFullReport()" class="md:col-span-4 px-4 py-2 rounded-xl border-2 dark:bg-slate-900 dark:text-white dark:border-slate-700 font-black text-[10px] uppercase outline-none">
                        <option value="">TODOS LOS PERFILES</option>
                        ${PROFILES.map(p => `<option value="${p}">${p}</option>`).join('')}
                    </select>
                </div>
                <div class="flex-1 overflow-auto no-scrollbar rounded-3xl border border-slate-200 dark:border-slate-800">
                    <table class="w-full text-[10px] text-left print-table">
                        <thead class="bg-slate-50 dark:bg-slate-800 font-black uppercase text-[8px] sticky top-0 dark:text-slate-400">
                            <tr><th class="p-3">FECHA/HORA</th><th class="p-3">SUJETO</th><th class="p-3">PERFIL</th><th class="p-3">MODO</th><th class="p-3">OBSERVACI√ìN</th></tr>
                        </thead>
                        <tbody id="full-report-table" class="divide-y dark:divide-slate-800 font-medium"></tbody>
                    </table>
                </div>
            </div>`;
            window.updateFullReport();
        }

        function renderUsersAdminView(container) {
            container.innerHTML = `
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 animate-fade-in text-left no-print">
                <div class="xl:col-span-4">
                    <div class="bg-white dark:bg-slate-900/50 p-8 rounded-[3rem] shadow-xl border border-slate-200 dark:border-slate-800 text-left backdrop-blur-sm">
                        <h3 class="text-xs font-black uppercase italic mb-6 dark:text-white text-center">Alta de Operador</h3>
                        <form id="user-form" class="space-y-4" onsubmit="event.preventDefault(); handleSaveUser();">
                            <input type="text" id="user-id" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none" placeholder="MATR√çCULA / DNI">
                            <input type="text" id="user-name" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none" placeholder="APELLIDO Y NOMBRE">
                            <input type="password" id="user-pass" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none" placeholder="CONTRASE√ëA">
                            <select id="user-role" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs uppercase outline-none">
                                <option value="${ROLES.UCP}">${ROLES.UCP}</option>
                                ${activeRole !== ROLES.UCP ? `<option value="${ROLES.DIP}">${ROLES.DIP}</option>` : ''}
                                ${activeRole === ROLES.ADMIN ? `<option value="${ROLES.ADMIN}">${ROLES.ADMIN}</option>` : ''}
                            </select>
                            <button type="submit" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg uppercase text-[10px] transition-all hover:opacity-90">Crear Operador</button>
                        </form>
                    </div>
                </div>
                <div class="xl:col-span-8 bg-white dark:bg-slate-900/50 rounded-[3rem] border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden flex flex-col text-left backdrop-blur-sm">
                    <div class="p-4 bg-slate-50 dark:bg-slate-800/80 font-black text-[9px] uppercase italic text-slate-400">Listado de Personal</div>
                    <div class="flex-1 overflow-auto no-scrollbar"><table class="w-full text-left text-[11px]"><tbody id="users-table-body" class="divide-y dark:divide-slate-800"></tbody></table></div>
                </div>
            </div>`;
            window.refreshUsersList();
        }

        function renderImportModule(name, api, fileId, changeFn, stats, uploadFn) {
            return `
            <div class="max-w-xl mx-auto bg-white dark:bg-slate-900/50 p-10 rounded-[3rem] shadow-2xl border border-slate-200 dark:border-slate-800 animate-fade-in no-print text-left backdrop-blur-sm">
                <div class="w-20 h-20 bg-slate-50 dark:bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl shadow-inner">üì•</div>
                <h2 class="text-xl font-black uppercase mb-1 italic dark:text-white text-center">${name}</h2>
                <div class="grid grid-cols-2 gap-3 my-8 text-left text-left">
                    <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border border-slate-200 dark:border-slate-700">
                        <p class="text-[8px] font-black text-slate-400 uppercase">√öltima Sincronizaci√≥n</p>
                        <p class="text-[10px] font-bold text-blue-600 dark:text-blue-400">${stats.date}</p>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border border-slate-200 dark:border-slate-700">
                        <p class="text-[8px] font-black text-slate-400 uppercase">Registros en Nube</p>
                        <p class="text-[10px] font-bold text-emerald-600 dark:text-emerald-400">${stats.count}</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-3xl p-8 bg-slate-50 dark:bg-slate-800 text-center">
                        <input type="file" id="${fileId}" class="hidden" onchange="${changeFn}">
                        <p id="file-label-${fileId}" class="text-[10px] font-black uppercase text-slate-500 mb-4 tracking-widest text-center">Planilla Excel (.xlsx)</p>
                        <button onclick="document.getElementById('${fileId}').click()" class="bg-slate-200 dark:bg-slate-700 dark:text-white text-slate-800 font-black px-6 py-3 rounded-xl uppercase text-[9px] tracking-widest hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
                            1. Elegir Planilla
                        </button>
                    </div>
                    <button id="btn-upload-${fileId}" onclick="${uploadFn}" disabled class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg uppercase text-[10px] tracking-widest opacity-30 cursor-not-allowed transition-all">
                        2. Sincronizar Cambios
                    </button>
                </div>
            </div>`;
        }

        // --- L√ìGICA DE USUARIOS ---
        window.handleSaveUser = async () => {
            const id = document.getElementById('user-id').value.trim();
            const name = document.getElementById('user-name').value.trim();
            const pass = document.getElementById('user-pass').value;
            const role = document.getElementById('user-role').value;
            if(!id || !name || !pass) return showMessage("Complete todos los campos", "error");
            try {
                await fbSetDoc(fbDoc(fbDbRegistros, 'artifacts', 'ucp-registros', 'public', 'data', 'users', id), { id, fullName: name.toUpperCase(), password: pass, role, creatorRole: activeRole, creatorId: currentUser.username, timestamp: Date.now() });
                showMessage("Usuario guardado", "success");
                document.getElementById('user-form').reset();
            } catch(e) { showMessage("Error en base de datos", "error"); }
        };

        window.refreshUsersList = () => {
            const body = document.getElementById('users-table-body'); if(!body) return;
            let visibleUsers = window.SYSTEM_USERS;
            if(activeRole === ROLES.DIP) visibleUsers = window.SYSTEM_USERS.filter(u => u.role === ROLES.DIP || u.role === ROLES.UCP);
            else if(activeRole === ROLES.UCP) visibleUsers = window.SYSTEM_USERS.filter(u => u.id === currentUser.username);
            body.innerHTML = visibleUsers.map(u => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors text-left text-left">
                    <td class="p-4 border-b border-slate-200 dark:border-slate-800">
                        <div class="font-black uppercase text-[10px] dark:text-white">${u.fullName}</div>
                        <div class="text-[8px] text-slate-400 font-bold uppercase">${u.role} | ID: ${u.id}</div>
                    </td>
                    <td class="p-4 border-b border-slate-200 dark:border-slate-800 text-right">
                        <button onclick="resetPass('${u.id}')" title="Reset Clave" class="p-2 text-blue-500 hover:bg-blue-100 dark:hover:bg-blue-900/40 rounded-lg">üîë</button>
                        ${(activeRole === ROLES.ADMIN || (activeRole === ROLES.DIP && u.role !== ROLES.ADMIN)) ? `<button onclick="deleteUser('${u.id}')" class="p-2 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/40 rounded-lg">üóëÔ∏è</button>` : ''}
                    </td>
                </tr>`).join('');
        };

        window.resetPass = async (id) => {
            const n = prompt("Nueva clave para "+id); if(n) { try { await fbUpdateDoc(fbDoc(fbDbRegistros, 'artifacts', 'ucp-registros', 'public', 'data', 'users', id), { password: n }); showMessage("Clave actualizada", "success"); } catch(e) {} }
        };

        window.deleteUser = async (id) => { if(confirm("¬øEliminar usuario "+id+"?")) { try { await fbDeleteDoc(fbDoc(fbDbRegistros, 'artifacts', 'ucp-registros', 'public', 'data', 'users', id)); showMessage("Eliminado", "success"); } catch(e) {} } };

        window.updateFullReport = () => {
            const b = document.getElementById('full-report-table'); if(!b) return;
            const search = document.getElementById('filter-search').value.toUpperCase();
            const start = document.getElementById('filter-start').value, end = document.getElementById('filter-end').value, prof = document.getElementById('filter-profile').value;
            const filtered = window.ingresosRecientes.filter(i => {
                const ms = !search || [i.sujeto, i.nomSujeto, i.obs, i.dominio, i.matProf].some(f => f && String(f).toUpperCase().includes(search));
                const mp = !prof || i.perfil === prof;
                const md = (!start || i.fecha >= start) && (!end || i.fecha <= end);
                return ms && mp && md;
            });
            b.innerHTML = filtered.map(i => `
                <tr class="font-bold text-slate-600 dark:text-slate-400 text-left">
                    <td class="p-3 border-b border-slate-200 dark:border-slate-800 leading-tight">${i.fecha}<br><span class="text-blue-500 text-[8px]">${i.hora}</span></td>
                    <td class="p-3 border-b border-slate-200 dark:border-slate-800 uppercase dark:text-slate-300">
                        ${i.nomSujeto || i.sujeto} ${i.matProf ? `<br><span class="text-[7px] text-blue-500 font-black">MAT: ${i.matProf}</span>` : ''}
                    </td>
                    <td class="p-3 border-b border-slate-200 dark:border-slate-800 text-blue-500 uppercase">${i.perfil}</td>
                    <td class="p-3 border-b border-slate-200 dark:border-slate-800 uppercase">${i.modo}</td>
                    <td class="p-3 border-b border-slate-200 dark:border-slate-800 text-[9px] uppercase italic leading-tight">${i.obs || '-'}</td>
                </tr>`).join('');
        };

        window.startScanner = (type) => {
            document.getElementById('modal-scanner').classList.remove('hidden'); html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (t) => {
                stopScanner(); if(type === 'LOGIN') document.getElementById('username').value = t;
                else { const i = document.getElementById('ing-dni') || document.getElementById('ing-mat'); if(i) { i.value = t; window.searchPersonalInDB(t); } }
            }, () => {} ).catch(stopScanner);
        };

        window.stopScanner = () => { if(html5QrCode) html5QrCode.stop().finally(() => { document.getElementById('modal-scanner').classList.add('hidden'); html5QrCode = null; }); else document.getElementById('modal-scanner').classList.add('hidden'); };

        window.updateDynamicFields = (perfil) => {
            const container = document.getElementById('dyn-fields'); if(!container) return;
            if (perfil === 'PERSONAL' || perfil === 'MOVIL') {
                container.innerHTML = `<div class="flex gap-2 text-left text-left"><input type="text" id="ing-mat" oninput="window.searchPersonalInDB(this.value)" class="flex-1 px-4 py-3 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none" placeholder="MATR√çCULA / AFILIADO"><button type="button" onclick="startScanner('SUJETO')" class="p-3 bg-slate-100 dark:bg-slate-700 rounded-xl hover:bg-blue-600 transition-colors text-slate-800 dark:text-white text-center">üìü</button></div><div id="crossover-preview" class="hidden p-5 bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-900/30 rounded-[2rem] animate-fade-in"><p id="prev-name" class="font-black text-blue-800 dark:text-blue-300 uppercase text-xs mb-1"></p><p id="prev-cargo" class="font-bold text-slate-500 dark:text-slate-400 uppercase text-[9px] mb-3"></p><div class="flex justify-between items-center bg-white dark:bg-slate-900/50 p-3 rounded-xl border border-slate-200 dark:border-blue-900/30"><span class="text-[9px] font-black uppercase text-slate-400">Pases Body Scan (60d)</span><span id="prev-body-count" class="bg-blue-600 text-white px-3 py-1 rounded-lg font-black text-xs">0</span></div></div>`;
            } else if (perfil === 'ABOGADO') {
                container.innerHTML = `<div class="flex gap-2 text-left text-left"><input type="text" id="ing-dni" class="flex-1 px-4 py-3 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none" placeholder="DNI"><button type="button" onclick="startScanner('SUJETO')" class="p-3 bg-slate-100 dark:bg-slate-700 rounded-xl hover:bg-blue-600 transition-colors text-slate-800 dark:text-white text-center">üì∏</button></div><input type="text" id="ing-nom" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none" placeholder="APELLIDO Y NOMBRE"><input type="text" id="ing-mat-prof" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none" placeholder="MATR√çCULA PROFESIONAL">`;
            } else {
                container.innerHTML = `<div class="flex gap-2 text-left text-left"><input type="text" id="ing-dni" class="flex-1 px-4 py-3 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none" placeholder="DNI"><button type="button" onclick="startScanner('SUJETO')" class="p-3 bg-slate-100 dark:bg-slate-700 rounded-xl hover:bg-blue-600 transition-colors text-slate-800 dark:text-white text-center">üì∏</button></div><input type="text" id="ing-nom" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 dark:text-white border-2 dark:border-slate-700 rounded-xl font-black text-xs outline-none" placeholder="APELLIDO Y NOMBRE">`;
            }
        };

        window.searchPersonalInDB = (val) => {
            const id = val.trim().toUpperCase(); const preview = document.getElementById('crossover-preview'); if(!id || !preview) { if(preview) preview.classList.add('hidden'); return; }
            const agent = window.PERSONAL_DB.find(p => String(p.id).toUpperCase() === id);
            const sixtyDaysAgo = Date.now() - (60 * 24 * 60 * 60 * 1000);
            const pases = window.pasesBodyData.filter(b => String(b.matricula).toUpperCase() === id && (b.timestamp || 0) > sixtyDaysAgo);
            if (agent || pases.length > 0) {
                preview.classList.remove('hidden'); document.getElementById('prev-name').innerText = agent ? `${agent.apellidoNombre}` : 'AGENTE SIN FICHA';
                document.getElementById('prev-cargo').innerText = agent ? agent.jerarquia : 'MATRICULA DETECTADA'; document.getElementById('prev-body-count').innerText = pases.length;
            } else { preview.classList.add('hidden'); }
        };

        async function handleSaveIngreso() {
            const p = document.getElementById('ing-perfil').value, m = document.getElementById('ing-modo').value, s = (document.getElementById('ing-dni')?.value || document.getElementById('ing-mat')?.value || "").trim();
            if(!p || !s || !m) return showMessage("Faltan datos", "error");
            const data = { fecha: document.getElementById('ing-fecha').value, hora: document.getElementById('ing-hora').value, perfil: p, modo: m, sujeto: s.toUpperCase(), nomSujeto: (document.getElementById('ing-nom')?.value || document.getElementById('prev-name')?.innerText || "").toUpperCase(), matProf: (document.getElementById('ing-mat-prof')?.value || "").toUpperCase(), obs: document.getElementById('ing-obs').value.toUpperCase(), dominio: (document.getElementById('ing-dominio')?.value || "").toUpperCase(), operador: currentUser.username, timestamp: Date.now() };
            try { await fbAddDoc(fbCollection(fbDbRegistros, 'artifacts', 'ucp-registros', 'public', 'data', 'ingresos'), data); showMessage("REGISTRADO", "success"); renderView('ingresos', 'REGISTRO INGRESOS'); } catch (e) { showMessage("Error Nube", "error"); }
        }

        window.updateIngresosTable = () => {
            const b = document.getElementById('ingresos-table'); if(!b) return;
            b.innerHTML = window.ingresosRecientes.slice(0, 15).map(i => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 text-left transition-colors text-left">
                    <td class="p-4 font-black text-blue-500 dark:text-blue-400 border-b border-slate-200 dark:border-slate-800">${i.hora}</td>
                    <td class="p-4 border-b border-slate-200 dark:border-slate-800 font-black uppercase text-[10px] dark:text-slate-300">${i.nomSujeto || i.sujeto}</td>
                </tr>`).join('');
        };

        // --- PROCESAMIENTO EXCEL ---
        async function processPersonalFile(input) {
            if (!input.files.length) return; const file = input.files[0]; document.getElementById('file-label-personal-file').innerText = `Archivo: ${file.name}`;
            const reader = new FileReader(); reader.onload = (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                window.pendingPersonal = rawData.map(row => ({ id: String(row.Matricula || row.MATRICULA || "").trim(), dni: String(row.DNI || "").trim(), jerarquia: String(row.Jerarquia || row.JERARQUIA || "").trim(), apellidoNombre: String(row['Apellido y Nombre'] || row.APELLIDO_Y_NOMBRE || "").trim() })).filter(p => p.id);
                const btn = document.getElementById('btn-upload-personal-file'); btn.disabled = false; btn.classList.remove('opacity-30', 'cursor-not-allowed'); btn.innerText = `Subir ${window.pendingPersonal.length} Agentes`;
            }; reader.readAsArrayBuffer(file);
        }

        async function processBodyFile(input) {
            if (!input.files.length) return; const file = input.files[0]; document.getElementById('file-label-body-file').innerText = `Archivo: ${file.name}`;
            const reader = new FileReader(); reader.onload = (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                const list = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]).map(row => ({ matricula: String(row.Matricula || row.MATRICULA || row.ID || "").trim(), nombre: String(row.Nombre || row.NOMBRE || "").trim(), fechaHora: String(row['Fecha y Hora'] || row.FECHA_HORA || "").trim(), sector: String(row.Sector || row.SECTOR || "S/D").trim(), timestamp: Date.now() })).filter(p => p.matricula);
                const existingKeys = new Set(window.pasesBodyData.map(p => `${p.matricula}|${p.fechaHora}`));
                window.pendingBody = list.filter(p => !existingKeys.has(`${p.matricula}|${p.fechaHora}`));
                const btn = document.getElementById('btn-upload-body-file'); btn.disabled = false; btn.classList.remove('opacity-30', 'cursor-not-allowed'); btn.innerText = `Subir ${window.pendingBody.length} Pases Nuevos`;
                if(window.pendingBody.length === 0) showMessage("No se detectaron registros nuevos.", "info");
            }; reader.readAsArrayBuffer(file);
        }

        // --- SUBIDA OPTIMIZADA CON PROGRESO (FIREBASE DIVIDIDO) ---
        window.uploadPersonal = async () => {
            if (!window.pendingPersonal || !window.pendingPersonal.length) return;
            const list = window.pendingPersonal;
            const total = list.length;
            let current = 0;
            
            setUploadProgress(true, 0, total);
            const chunks = []; for (let i = 0; i < list.length; i += 400) chunks.push(list.slice(i, i + 400));
            
            for (const chunk of chunks) {
                const batch = fbWriteBatch(window.fbDbPersonal);
                chunk.forEach(p => { 
                    const id = String(p.id).trim().toUpperCase(); 
                    batch.set(fbDoc(window.fbDbPersonal, 'artifacts', 'ucp-personal', 'public', 'data', 'personal', id), p, { merge: true }); 
                });
                await batch.commit();
                current += chunk.length;
                setUploadProgress(true, current, total);
            }

            window.importStats.personal = { date: new Date().toLocaleString(), count: window.PERSONAL_DB.length };
            localStorage.setItem('ucp_import_stats', JSON.stringify(window.importStats));
            window.pendingPersonal = null;
            setTimeout(() => setUploadProgress(false), 500);
            showMessage(`Se han subido exitosamente ${total} agentes`, "success");
            renderView('importar_personal', 'PERSONAL');
        };

        window.uploadBody = async () => {
            if (!window.pendingBody || !window.pendingBody.length) return;
            const list = window.pendingBody;
            const total = list.length;
            let current = 0;

            setUploadProgress(true, 0, total);
            const chunks = []; for (let i = 0; i < list.length; i += 400) chunks.push(list.slice(i, i + 400));
            
            for (const chunk of chunks) {
                const batch = fbWriteBatch(window.fbDbBody);
                chunk.forEach(p => { 
                    batch.set(fbDoc(fbCollection(window.fbDbBody, 'artifacts', 'ucp-body', 'public', 'data', 'pases_body')), p); 
                });
                await batch.commit();
                current += chunk.length;
                setUploadProgress(true, current, total);
            }

            window.importStats.body = { date: new Date().toLocaleString(), count: window.pasesBodyData.length };
            localStorage.setItem('ucp_import_stats', JSON.stringify(window.importStats));
            window.pendingBody = null;
            setTimeout(() => setUploadProgress(false), 500);
            showMessage(`Proceso completo: ${total} registros a√±adidos`, "success");
            renderView('importar_body', 'BODY SCAN');
        };

        window.setMode = (m) => {
            document.getElementById('ing-modo').value = m;
            document.getElementById('btn-p').className = `flex-1 py-3 border-2 rounded-xl text-xl ${m==='PEAT√ìN'?'bg-blue-600 text-white border-blue-600 shadow-inner':'bg-white dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700'}`;
            document.getElementById('btn-v').className = `flex-1 py-3 border-2 rounded-xl text-xl ${m==='VEH√çCULO'?'bg-blue-600 text-white border-blue-600 shadow-inner':'bg-white dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700'}`;
            if(m==='VEH√çCULO') document.getElementById('vehicle-fields').classList.remove('hidden'); else document.getElementById('vehicle-fields').classList.add('hidden');
        };

        window.exportToExcel = () => { const ws = XLSX.utils.json_to_sheet(window.ingresosRecientes); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Auditoria"); XLSX.writeFile(wb, "Auditoria_UCP.xlsx"); };

        window.toggleTheme = () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeToggleIcon();
        };

        function updateThemeToggleIcon() {
            const icon = document.getElementById('theme-icon'); if(!icon) return;
            icon.innerText = document.documentElement.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
        }

        window.toggleFullscreen = () => {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => showMessage("Error pantalla completa", "error"));
            else document.exitFullscreen();
        };

        document.addEventListener('fullscreenchange', () => {
            const icon = document.getElementById('full-icon'); if(!icon) return;
            icon.innerText = document.fullscreenElement ? '‚ùê' : '‚õ∂';
        });
    </script>
</body>
</html>
